<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>11&nbsp; 自然実験:再訪 – Empirical Research in Accounting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./appA_LinearAlgebra.html" rel="next">
<link href="./chap18_Causal_mechanisms.html" rel="prev">
<link href="./img/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-1092c56c6cadf2eb47b1bc8063ab382a.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-1092c56c6cadf2eb47b1bc8063ab382a.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c58e7bee4ee1a6584ec9d1fc0e841892.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-2e8bc3580cc84ea2920b26bb0544913d.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta name="twitter:title" content="11&nbsp; 自然実験:再訪 – Empirical Research in Accounting">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chap17_Natural.html">因果推論</a></li><li class="breadcrumb-item"><a href="./chap19_Natural_experiments_revisited.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">自然実験:再訪</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Empirical Research in Accounting</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/ma2ura/ER4A/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">序論</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">基礎</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap01_Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">はじめに</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap09_import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">データを読み込む</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">資本市場研究</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap10_FFJR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">FFJR</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap11_BB1968.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Ball and Brown (1968)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap12_Beaver1968.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Beaver (1968)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap13_Event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">イベント・スタディ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap15_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">アクルーアル</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap16_em.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">利益マネジメント</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">因果推論</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap17_Natural.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">自然実験</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap18_Causal_mechanisms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">因果メカニズム</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chap19_Natural_experiments_revisited.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">自然実験:再訪</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">追加的なトピック</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appA_LinearAlgebra.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">線形代数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appB_SQL.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">SQL入門</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appC_Computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">研究のためのコンピュータ概論</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#%E5%86%8D%E7%8F%BE%E5%8D%B1%E6%A9%9F" id="toc-再現危機" class="nav-link active" data-scroll-target="#%E5%86%8D%E7%8F%BE%E5%8D%B1%E6%A9%9F"><span class="header-section-number">11.1</span> 再現危機？</a>
  <ul class="collapse">
<li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C" id="toc-ディスカッション課題" class="nav-link" data-scroll-target="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C"><span class="header-section-number">11.1.1</span> ディスカッション課題</a></li>
  </ul>
</li>
  <li>
<a href="#the-reg-sho-experiment" id="toc-the-reg-sho-experiment" class="nav-link" data-scroll-target="#the-reg-sho-experiment"><span class="header-section-number">11.2</span> The Reg SHO experiment</a>
  <ul class="collapse">
<li><a href="#sho%E3%83%91%E3%82%A4%E3%83%AD%E3%83%83%E3%83%88%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB" id="toc-shoパイロットサンプル" class="nav-link" data-scroll-target="#sho%E3%83%91%E3%82%A4%E3%83%AD%E3%83%83%E3%83%88%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><span class="header-section-number">11.2.1</span> SHOパイロットサンプル</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">11.2.2</span> Exercises</a></li>
  <li><a href="#reg-sho%E3%81%AE%E5%88%9D%E6%9C%9F%E3%81%AE%E7%A0%94%E7%A9%B6" id="toc-reg-shoの初期の研究" class="nav-link" data-scroll-target="#reg-sho%E3%81%AE%E5%88%9D%E6%9C%9F%E3%81%AE%E7%A0%94%E7%A9%B6"><span class="header-section-number">11.2.3</span> Reg SHOの初期の研究</a></li>
  <li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C%E3%81%A8%E7%B7%B4%E7%BF%92%E5%95%8F%E9%A1%8C" id="toc-ディスカッション課題と練習問題" class="nav-link" data-scroll-target="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C%E3%81%A8%E7%B7%B4%E7%BF%92%E5%95%8F%E9%A1%8C"><span class="header-section-number">11.2.4</span> ディスカッション課題と練習問題</a></li>
  </ul>
</li>
  <li><a href="#%E8%87%AA%E7%84%B6%E5%AE%9F%E9%A8%93%E3%81%AE%E5%88%86%E6%9E%90" id="toc-自然実験の分析" class="nav-link" data-scroll-target="#%E8%87%AA%E7%84%B6%E5%AE%9F%E9%A8%93%E3%81%AE%E5%88%86%E6%9E%90"><span class="header-section-number">11.3</span> 自然実験の分析</a></li>
  <li><a href="#valuating-natural-experiments" id="toc-valuating-natural-experiments" class="nav-link" data-scroll-target="#valuating-natural-experiments"><span class="header-section-number">11.4</span> valuating natural experiments</a></li>
  <li><a href="#the-parallel-trends-assumption" id="toc-the-parallel-trends-assumption" class="nav-link" data-scroll-target="#the-parallel-trends-assumption"><span class="header-section-number">11.5</span> The parallel trends assumption</a></li>
  <li>
<a href="#indirect-effects-of-reg-sho" id="toc-indirect-effects-of-reg-sho" class="nav-link" data-scroll-target="#indirect-effects-of-reg-sho"><span class="header-section-number">11.6</span> Indirect effects of Reg SHO</a>
  <ul class="collapse">
<li><a href="#earnings-management-after-dechow-et-al.-1995" id="toc-earnings-management-after-dechow-et-al.-1995" class="nav-link" data-scroll-target="#earnings-management-after-dechow-et-al.-1995"><span class="header-section-number">11.6.1</span> Earnings management after Dechow et al.&nbsp;(1995)</a></li>
  <li><a href="#fhk-data-steps" id="toc-fhk-data-steps" class="nav-link" data-scroll-target="#fhk-data-steps"><span class="header-section-number">11.6.2</span> FHK: Data steps</a></li>
  <li><a href="#discussion-questions-and-exercises" id="toc-discussion-questions-and-exercises" class="nav-link" data-scroll-target="#discussion-questions-and-exercises"><span class="header-section-number">11.6.3</span> Discussion questions and exercises</a></li>
  <li><a href="#fhk-regression-analysis" id="toc-fhk-regression-analysis" class="nav-link" data-scroll-target="#fhk-regression-analysis"><span class="header-section-number">11.6.4</span> FHK: Regression analysis</a></li>
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1"><span class="header-section-number">11.6.5</span> Exercises</a></li>
  </ul>
</li>
  <li>
<a href="#%E7%B5%B1%E8%A8%88%E7%9A%84%E6%8E%A8%E8%AB%96" id="toc-統計的推論" class="nav-link" data-scroll-target="#%E7%B5%B1%E8%A8%88%E7%9A%84%E6%8E%A8%E8%AB%96"><span class="header-section-number">11.7</span> 統計的推論</a>
  <ul class="collapse">
<li><a href="#%E7%B7%B4%E7%BF%92%E5%95%8F%E9%A1%8C" id="toc-練習問題" class="nav-link" data-scroll-target="#%E7%B7%B4%E7%BF%92%E5%95%8F%E9%A1%8C"><span class="header-section-number">11.7.1</span> 練習問題</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%9B%A0%E6%9E%9C%E3%83%80%E3%82%A4%E3%82%A2%E3%82%B0%E3%83%A9%E3%83%A0" id="toc-因果ダイアグラム" class="nav-link" data-scroll-target="#%E5%9B%A0%E6%9E%9C%E3%83%80%E3%82%A4%E3%82%A2%E3%82%B0%E3%83%A9%E3%83%A0"><span class="header-section-number">11.8</span> 因果ダイアグラム</a>
  <ul class="collapse">
<li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C-1" id="toc-ディスカッション課題-1" class="nav-link" data-scroll-target="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C-1"><span class="header-section-number">11.8.1</span> ディスカッション課題</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%9B%A0%E6%9E%9C%E3%83%A1%E3%82%AB%E3%83%8B%E3%82%BA%E3%83%A0" id="toc-因果メカニズム" class="nav-link" data-scroll-target="#%E5%9B%A0%E6%9E%9C%E3%83%A1%E3%82%AB%E3%83%8B%E3%82%BA%E3%83%A0"><span class="header-section-number">11.9</span> 因果メカニズム</a>
  <ul class="collapse">
<li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C-2" id="toc-ディスカッション課題-2" class="nav-link" data-scroll-target="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C-2"><span class="header-section-number">11.9.1</span> ディスカッション課題</a></li>
  </ul>
</li>
  <li>
<a href="#%E4%BA%8C%E6%AE%B5%E9%9A%8E%E5%9B%9E%E5%B8%B0" id="toc-二段階回帰" class="nav-link" data-scroll-target="#%E4%BA%8C%E6%AE%B5%E9%9A%8E%E5%9B%9E%E5%B8%B0"><span class="header-section-number">11.10</span> 二段階回帰</a>
  <ul class="collapse">
<li><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C-3" id="toc-ディスカッション課題-3" class="nav-link" data-scroll-target="#%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E8%AA%B2%E9%A1%8C-3"><span class="header-section-number">11.10.1</span> ディスカッション課題</a></li>
  </ul>
</li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">11.11</span> References</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chap17_Natural.html">因果推論</a></li><li class="breadcrumb-item"><a href="./chap19_Natural_experiments_revisited.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">自然実験:再訪</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">11</span>&nbsp; <span class="chapter-title">自然実験:再訪</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><!-- # Natural experiments revisited --><!-- In this chapter, we return to the topic of natural experiments.  --><p>この章では、自然実験のトピックを再訪する。 <!-- We first discuss the notion of registered reports, their purpose, and their limitations.  --> まず、登録報告（Registered Reports）の概念、その目的、およびその限界について論じる。 <!-- We then focus on an experiment (“Reg SHO”) run by the US Securities and Exchange Commission (SEC) and studies that examined the effects of Reg SHO, with a particular focus on one study (Fang et al., 2016) that exploited this regulation to study effects on earnings management. --> 次に、米国証券取引委員会(SEC)によって実施された実験「Reg SHO」と、それに関する研究を検討する。特に、Fang et al.（2016）の研究に焦点を当て、この規制を利用して利益マネジメント(Earnings Management)への影響を分析した点を詳しく論じる。</p>
<!-- This chapter provides opportunities to sharpen our skills and knowledge in a number of areas.  -->
<p>この章では、以下のような領域でスキルと知識を磨く機会を提供する。 <!-- First, we will revisit the topic of earnings management and learn about some developments in its measurement since Dechow et al. (1995), which we covered in Chapter 16.  --> 第1に、利益マネジメントのテーマを再訪し、Dechow et al.&nbsp;(1995)以来の測定手法の発展について学ぶ。このテーマは第16章ですでに扱っている。 <!-- Second, we further develop our skills in evaluating claimed natural experiments, using Reg SHO and the much-studied setting of broker-closure shocks.  --> 第2に、Reg SHOおよび頻繁に研究されている証券会社の閉鎖(broker-closure shocks)の事例を用いて、自然実験とされる評価スキルをさらに発展させる。 <!-- Third, we explore the popular difference-in-differences approach, both when predicated on random assignment and when based on the so-called parallel trends assumption in the absence of random assignment.  --> 第3に、差分の差(diffrence-in-differences)手法を探求し、ランダムな割当がある場合と、ランダムな割当がない場合の「平行トレンド仮定」(parallel trends assumption)に基づく場合の両方について考察する。 <!-- Fourth, we will have an additional opportunity to apply ideas related to causal diagrams and causal mechanisms (covered in Chapters 4 and 18, respectively).  --> 第4に、第4章および第18章で扱った因果ダイアグラムと因果メカニズムに関連する概念を応用する機会をもつ。 <!-- Fifth, we will revisit the topic of statistical inference, using this chapter as an opportunity to consider randomization inference.  --> 第5に、統計的推論のテーマを再訪し、この章をランダム化推論(randomization inference)を考慮する機会として利用する。 <!-- Sixth, we build on the Frisch-Waugh-Lovell theorem to consider issues associated with the use of two-step regressions, which are common in many areas of accounting research. --> 第6に、Frisch-Waugh-Lovellの定理を基に、会計研究の多くの分野で一般的な二段階回帰の使用に関連する問題を考察する。</p>
<div class="callout callout-style-simple callout-tip">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The code in this chapter uses the packages listed below. We load tidyverse because we use several packages from the Tidyverse. For instructions on how to set up your computer to use the code found in this book, see Section 1.2. Quarto templates for the exercises below are available on GitHub.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span>, <span class="va">DBI</span>, <span class="va">farr</span>, <span class="va">fixest</span>, <span class="va">modelsummary</span>, <span class="va">furrr</span>, <span class="va">broom</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<!-- This chapter is longer than others in the book, so we have made it easier to run code from one section without having to run all the code preceding it.  -->
<p>この章は、本書の他の章よりも長いため、それ以前のすべてのコードを実行する必要なしに、特定のセクションからコードを実行することができるようになっている。 <!-- Beyond that, the code in each of Sections 19.1–19.3 and 19.5 is independent of code in other parts of this chapter and can be run independently of those other sections.1  --> さらに、セクション19.1〜19.3および19.5の各セクションのコードは、この章の他の部分のコードとは独立しており、それらの他のセクションとは独立して実行できます。 <!-- Code and exercises in Sections 19.7 and 19.8 depend on code in Section 19.6, so you will need to run the code in Section 19.6 before running the code in those sections. --> セクション19.7および19.8のコードと演習は、セクション19.6のコードに依存しているため、これらのセクションのコードを実行する前に、セクション19.6のコードを実行する必要があります。</p>
</div>
</div>
</div>
<!-- ##  replication crisis? -->
<section id="再現危機" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="再現危機">
<span class="header-section-number">11.1</span> 再現危機？</h2>
<!-- A Financial Times article by Robert Wigglesworth discusses an alleged “replication crisis” in finance research.  -->
<p>ロバート・ウィグルズワースによるFinancial Timesの記事は、ファイナンス研究における「再現危機」を取り上げた。 <!-- Wigglesworth quotes Campbell Harvey, professor of finance at Duke University, who suggests that “at least half of the 400 supposedly market-beating strategies identified in top financial journals over the years are bogus.” --> Wigglesworthは、デューク大学のファイナンス教授であるCanmpbell Harveyの発言を引用しており、Harveyは「これまでのトップのファイナンス・ジャーナルで特定された400以上の市場を打ち負かすとされる戦略のうち、少なくとも半分は偽物である」と述べている。</p>
<!-- Wigglesworth identified “the heart of the issue” as what researchers call p-hacking, which is the practice whereby researchers search for “significant” and “positive” results.  -->
<p>Wigglesworthは、研究者が「有意な」および「ポジティブな」結果を探すという実践である<strong>p-hacking</strong>を研究者が行っていると指摘し、「問題の核心」を特定した。 <!-- Here “significant” refers to statistical significance and “positive” refers to results that reject so-called “null hypotheses” and thereby (purportedly) push human knowledge forward.  --> ここで「有意性」とは統計的有意性を指し、「ポジティブ」とはいわゆる「帰無仮説」を棄却し、それによって（推定される）人間の知識を前進させる結果を指す。 <!-- Harvey (2017) cites research suggesting that 90% of published studies report such “significant” and “positive” results.  --> Harvey（2017）は、90%の発表された研究がこのような「有意な」および「ポジティブな」結果を報告していると示唆する研究を引用している。 <!-- Reporting “positive” results is important not only for getting published, but also for attracting citations, which can drive behaviour of both researchers and journals. --> 「ポジティブ」な結果を報告することは、出版されるだけでなく、引用を集めるためにも重要であり、これは研究者やジャーナルの行動を促すことができる。</p>
<!-- Simmons et al. (2011, p.1359) describe what they term researcher degrees of freedom.  -->
<p>Simmons et al.（2011, p.1359）は、彼らが研究者の自由度と呼ぶものを説明している。 <!-- “In the course of collecting and analyzing data, researchers have many decisions to make: Should more data be collected?  --> <!-- Should some observations be excluded? Which conditions should be combined and which ones compared? Which control variables should be considered? Should specific measures be combined or transformed or both?”  --> 「データを収集し分析する過程で、研究者は多くの決定を下さなければならない。より多くのデータを収集すべきか？ 一部の観測を除外すべきか？ どの条件を統合し、どの条件を比較すべきか？ どの統制変数を考慮すべきか？ 特定の測定値を統合すべきか、それとも変換すべきか、あるいはその両方を行うべきか？」 <!-- Simmons et al. (2011, p.1364) identify another well-known **researcher degree of freedom**, namely that of “reporting only experiments that ‘work’”, which is known as the **file-drawer problem** (because experiments that don’t “work” are put in a file-drawer). --> Simmons et al.&nbsp;(2011, p.1364) は、もう一つのよく知られた<strong>研究者の自由度</strong>として、「うまくいった実験のみを報告する」ことを挙げている。これは「<strong>ファイルドロワー問題</strong>」として知られており、うまくいかなかった実験が引き出しにしまわれてしまうことを指す。</p>
<!-- To illustrate the power of researcher degrees of freedom, Simmons et al. (2011) conducted two hypothetical studies based experiments with live subjects.  -->
<p>研究者の自由度の影響力を示すために、Simmons et al.&nbsp;(2011) は、ライブの被験者を用いた実験に基づく2つの仮想的な研究を実施した。 <!-- They argue that these studies “demonstrate how unacceptably easy it is to accumulate (and report) statistically significant evidence for a false hypothesis” [p.1359].  --> 彼らは、これらの研究が「統計的に有意な証拠を、誤った仮説のために蓄積し（そして報告し）てしまうことが、いかに容認できないほど容易であるかを示している」と主張している [p.1359]。 <!-- Simmons et al. (2011, p.1359) conclude that “flexibility in data collection, analysis, and reporting dramatically increases actual false-positive rates.” --> また、Simmons et al.&nbsp;(2011, p.1359) は、「データ収集、分析、および報告における柔軟性が、実際の偽陽性率を劇的に上昇させる」と結論付けている。</p>
<!-- Perhaps in response to concerns similar to those raised by Simmons et al. (2011), the Journal of Accounting Research (JAR) conducted a trial for its annual conference held in May 2017.  -->
<p>おそらく、Simmons at al.&nbsp;(2011) が提起したものと同様の懸念に対応する形で、Journal of Accounting Research (JAR) は、2017年5月に開催された年次カンファレンスにおいて試験的な取り組みを実施した。 <!-- According to the JAR website, at this conference “authors presented papers developed through a Registration-based Editorial Process (REP).  --> JARのウェブサイトによると、このカンファレンスでは「著者が登録ベースの編集プロセス（Registration-based Editorial Process, REP）を通じて作成した論文を発表した」。 <!-- The goal of the conference was to see whether REP could be implemented for accounting research, and to explore how such a process could be best implemented.  --> このカンファレンスの目的は、会計研究においてREPを導入できるかを検証し、またその最適な実施方法を探ることであった。 <!-- Papers presented at the conference were subsequently published in May 2018. --> カンファレンスで発表された論文は、2018年5月にその後出版された。</p>
<!-- According to Bloomfield et al. (2018, p.317), “under REP, authors propose a plan to gather and analyze data to test their predictions.  -->
<p>Bloomfield et al.&nbsp;(2018, p.317) によると、「REPでは、著者が自身の予測を検証するためにデータを収集・分析する計画を提案する。 <!-- Journals send promising proposals to one or more reviewers and recommend revisions.  --> ジャーナルは、有望な提案を一人または複数の査読者に送付し、修正を推奨する。 <!-- Authors are given the opportunity to review their proposal in response, often multiple times, before the proposal is either rejected or granted in-principle acceptance … regardless of whether [subsequent] results support their predictions.” --> 著者はこれに応じて提案を見直す機会を与えられ、しばしば複数回の修正を経た後、提案はリジェクトされるか、または‘原則的アクセプト’が与えられる。… これは、[その後の] 結果が彼らの予測を支持するかどうかに関わらず行われる。」</p>
<!-- Bloomfield et al. (2018, p.317) contrast REP with the Traditional Editorial Process (“TEP”).  -->
<p>Bloomfield et al.&nbsp;(2018, p.317) は、REPと従来の編集プロセス（Traditional Editorial Process, TEP）を対比している。 <!-- Under the TEP, “authors gather their data, analyze it, and write and revise their manuscripts repeatedly before sending them to editors.”  --> TEPのもとでは、「著者はデータを収集し、分析し、原稿を執筆・修正したうえで、編集者に送る前に何度も見直しを行う」。 <!-- Bloomfield et al. (2018, p.317) suggest that “almost all peer-reviewed articles in social science are published under … the TEP.” --> また、Bloomfield et al.&nbsp;(2018, p.317) は、「社会科学の査読付き論文のほぼすべてが … TEPのもとで出版されている」と指摘している。</p>
<!-- The REP is designed to eliminate questionable research practices, including those identified by Simmons et al. (2011).  -->
<p>REPは、Simmons et al.&nbsp;(2011)によって特定されたものを含む疑問の余地のある研究手法を排除するために設計されている。 <!-- For example, one form of p-hacking is **HARKing** (from “Hypothesizing After Results are Known”).  --> たとえば、p-hackingの一形態は<strong>HARKing</strong>（「結果がわかってから仮説を立てる」）である。 <!-- In its extreme form, HARKing involves searching for a “significant” correlation and then developing a hypothesis to “predict” it.  --> その極端な形態では、HARKingは「有意な」相関を探し、それを「予測」するための仮説を立てることを含む。 <!-- To illustrate, consider the spurious correlations website provided by Tyler Vigen.  --> たとえば、Tyler Vigenが提供する<a href="https://tylervigen.com/spurious-correlations">見せかけの相関のウェブサイト</a>を考えてみよう。 <!-- This site lists a number of evidently spurious correlations, such as the 99.26% correlation between the divorce rate in Maine and margarine consumption or the 99.79% correlation between US spending on science, space, and technology and suicides by hanging, strangulation, and suffocation.  --> このサイトは、メイン州の離婚率とマーガリンの消費量の間の99.26%の相関や、アメリカの科学、宇宙、技術への支出と絞首、絞殺、窒息による自殺との間の99.79%の相関など、明らかにスパリアスな相関をいくつかリストしている。 <!-- The correlations are deemed spurious because normal human beings have strong prior beliefs that no underlying causal relation explains these correlations.  --> これらの相関は、通常の人間は、これらの相関を説明する根底にある因果関係がないという強い事前の信念を持っているため、見せかけのものと見なされる。 <!-- Instead, these are regarded as mere coincidence. --> これらは単なる偶然と見なされる。</p>
<!-- However, a creative academic can probably craft a story to “predict” any correlation.  -->
<p>しかし、創造的な学者はおそらく、どんな相関も「予測」するためのストーリーを作り出すことができる。 <!-- Perhaps increasing spending on science raises its perceived importance to society.  --> たとえば、科学への支出を増やすことで、それが社会にとって重要であるという認識が高まるかもしれない。 <!-- But drawing attention to science only serves to highlight how the United States has inevitably declined in relative stature in many fields, including science.  --> しかし、科学に注目することは、アメリカが科学を含む多くの分野で相対的に衰退していることを浮き彫りにするだけである。 <!-- While many Americans can carry on notwithstanding this decline, others are less sanguine about it and may go to extreme lengths as a result … .  --> この衰退にもかかわらず、多くのアメリカ人はこれを乗り越えることができるが、他の人々はそれについて楽観的ではなく、その結果として極端な手段に出るかもしれない…。</p>
<!-- This is clearly a silly line of reasoning, but if one added some references to published studies and fancy terminology, it would probably read a lot like the hypothesis development sections of some academic papers. -->
<p>これは明らかにばかげた推論であるが、もしいくつかの参考文献や洒落た用語を加えれば、おそらくいくつかの学術論文の仮説開発セクションとよく似たものになるだろう。</p>
<!-- Bloomfield et al. (2018, p.326) examine “the strength of the papers’ results” from the 2017 JAR conference in their section 4.2 and conclude that “of the 30 predictions made in the … seven proposals, we count 10 as being supported at $p \leq 0.05$ by at least one of the 134 statistical tests the authors reported.  -->
<p>Bloomfield et al.&nbsp;(2018, p.326) は、2017年のJARカンファレンスからの「論文の結果の強さ」を彼らのセクション4.2で検討し、結論付けている。「… 7つの提案で行われた30の予測のうち、著者が報告した134の統計的検定のうち、少なくとも1つで<span class="math inline">p \leq 0.05</span>で支持されると数えられるものは10つある。 <!-- The remaining 20 predictions are not supported at $p \leq 0.05$ by any of the 84 reported tests.  --> 残りの20の予測は、報告された84の検定のいずれにも<span class="math inline">p \leq 0.05</span>で支持されていない。 <!-- Overall, our analysis suggests that the papers support the authors’ predictions far less strongly than is typical among papers published in JAR and its peers.” [^2] --> 全体的に、我々の分析は、論文がJARおよびその同僚誌に掲載された論文の中で一般的なよりもはるかに弱く、著者の予測を支持している」と述べている。[^2]</p>
<!-- ###  Discussion questions -->
<section id="ディスカッション課題" class="level3" data-number="11.1.1"><h3 data-number="11.1.1" class="anchored" data-anchor-id="ディスカッション課題">
<span class="header-section-number">11.1.1</span> ディスカッション課題</h3>
<!-- 1. Simmons et al. (2011) provide a more in-depth examination of issues with the TEP discussed in Bloomfield et al. (2018, pp.318–319).  -->
<ol type="1">
<li>Simmons et al.&nbsp;(2011) は、Bloomfield et al.&nbsp;(2018, pp.318–319)で議論されたTEPの問題について、より詳細な検討を行っている。 <!-- Do you think the two experiments studied by Simmons et al. (2011) are representative of how accounting research works in practice?  --> Simmons et al.（2011）が研究した2つの実験は、実際の会計研究の進め方を代表しているといえるか。 <!-- What differences are likely to exist in empirical accounting research using archival data? --> アーカイバル・データを使用した実証会計研究には、どのような違いがあるのか。</li>
</ol>
<!-- 2. Bloomfield et al. (2018, p.326) say “we exclude Hail et al. (2018) from our tabulation [of results] because it does not state formal hypotheses.”  --><ol start="2" type="1">
<li>Bloomfield et al.（2018, p.326）は、「Hail et al.（2018）は正式な仮説を提示していないため、[結果の] 集計から除外した」と述べている。 <!-- Given the lack of formal hypotheses, do you think it made sense to include the proposal from Hail et al. (2018) in the 2017 JAR conference?  --> 正式な仮説がないにもかかわらず、Hail et al.&nbsp;(2018) の提案を2017年の Journal of Accounting Research（JAR）カンファレンスに含めるのは妥当だったのだろうか？ <!-- Does the REP have relevance to papers without formal hypotheses?  --> REPは、正式な仮説を持たない論文にも適用可能なのか？ <!-- Does the absence of formal hypotheses imply that Hail et al. (2018) were not testing hypotheses?  --> 正式な仮説がないことは、Hail et al.&nbsp;(2018) が仮説を検証していないことを意味するのか？ <!-- Is your answer to the last question consistent with how Hail et al. (2018, p.650) discuss results reported in Table 5 of that paper? --> 最後の質問に対するあなたの答えは、Hail et al.&nbsp;(2018, p.650) が論文の Table 5 に関する結果をどのように議論しているかと整合しているだろうか？</li>
</ol>
<!-- 3. According to the analysis of Bloomfield et al. (2018), there were 218 tests of 30 hypotheses and different hypotheses had different numbers of tests.  --><ol start="3" type="1">
<li>Bloomfield et al.&nbsp;(2018)の分析によると、30の仮説に対して218のテストが行われ、異なる仮説には異なる数のテストが行われた。 <!-- In the following analysis, we assume 30 hypotheses with each having 7 tests (for a total of 210 tests).  --> 以下の分析では、30の仮説があり、それぞれが7つのテストを行うと仮定する（合計210のテスト）。 <!-- Does this analysis suggest an alternative possible interpretation of the results than the “far less strongly than is typical” conclusion offered by Bloomfield et al. (2018).  --> この分析は、Bloomfield et al.&nbsp;(2018)が提供した「通常よりもはるかに弱い」という結論以外の結果の可能性の代替的な解釈を示唆しているだろうか。 <!-- Does choosing a different value for `set.seed()` alter the tenor of the results from this analysis? --> <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code>の値を変更すると、この分析の結果の傾向が変わるだろうか？ <!-- How might you make the analysis below more definitive?3 --> 以下の分析をより確定的にするためには、どのようにすればよいだろうか？[^3]</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">expand_grid</span><span class="op">(</span>hypothesis <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, test <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         reject <span class="op">=</span> <span class="va">p</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">hypothesis</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>reject_one <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">reject</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">reject_one</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  reject_one     n
  &lt;lgl&gt;      &lt;int&gt;
1 FALSE         19
2 TRUE          11</code></pre>
</div>
</div>
<!-- 4. Bloomfield et al. (2018, p. 326) argue “it is easy to imagine revisions of several conference papers would allow them to report results of strength comparable to those found in most papers published under TEP.”  -->
<ol start="4" type="1">
<li>Bloomfield et al.&nbsp;(2018, p.&nbsp;326) は、「いくつかの会議論文の改訂により、TEP（Traditional Empirical Paradigm）で発表された論文の大半と同程度の強さの結果を報告できるようになることは容易に想像できる」と主張している。 <!-- For example, “Li and Sandino (2018) yielded no statistically significant support for their main hypotheses.  --> 例えば、「Li and Sandino (2018) は、主要な仮説に対する統計的に有意な支持を得られなかった。 <!-- However, they found significant results in their planned additional analyses that are consistent with informal predictions included in the accepted proposal.  --> <!-- … [In light of this evidence] we are not ready to conclude that the studies in the issue actually provide weaker support for their predictions than most studies published under TEP.” (2018, p. 326).  --> しかし、受理された提案書に含まれていた非公式な予測と整合的な計画的追加分析において、有意な結果を見出した。… [この証拠を踏まえると] 本号の研究が、TEP の下で発表された研究よりも予測に対する支持が弱いと結論づけるには至らない」（2018, p.&nbsp;326）と述べている。 <!-- Can these results instead be interpreted as saying something about the strength of results of studies published under TEP? --> これらの結果は、TEP のもとで発表された研究の結果の強さについて何かを示唆していると解釈することはできるだろうか？</li>
</ol>
<!-- 5. Do you believe that it would be feasible for REP to become the dominant research paradigm in accounting research? What challenges would such a development face? --><ol start="5" type="1">
<li>REP（Registered Reports and Enhanced Transparency Paradigm）が会計研究の主要な研究パラダイムとなることは現実的だろうか。その発展にはどのような課題が伴うのか。</li>
</ol>
<!-- 6. A respondent to the survey conducted by Bloomfield et al. (2018, p. 337) provided the remark quoted below. Comment on this remark. What do you think the respondent has in mind with regard to the “learning channel”? Do you agree that the REP shuts down this channel? --><ol start="6" type="1">
<li>Bloomfield et al.（2018, p.&nbsp;337）が実施した調査の回答者のコメントを以下に引用する。このコメントについて論じよ。回答者が「学習チャネル（learning channel）」についてどのような考えを持っていると考えられるか。また、REPがこのチャネルを閉ざしてしまうという指摘に賛同するか。</li>
</ol>
<blockquote class="blockquote">
<p>「『帰無結果（null results）』が多く報告されることに驚きは感じない。それは自らの経験からも容易に予測できることだ。研究は反復的なプロセスであり、学習を伴うものだ。特に、非常に新規性の高い研究課題で、我々がまだほとんど知らない領域において、学習チャネルを閉ざすことで研究プロセスにおいて何か有益な発見が得られるとは思えない。」</p>
</blockquote>
</section></section><section id="the-reg-sho-experiment" class="level2" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="the-reg-sho-experiment">
<span class="header-section-number">11.2</span> The Reg SHO experiment</h2>
<!-- To better understand the issues raised by the discussion above in a real research setting, we focus on the Reg SHO experiment, which has been the subject of many studies.  -->
<p>上記の議論で取り上げられた問題を実際の研究環境でよりよく理解するために、多くの研究の対象となってきたReg SHO実験に焦点を当てる。 <!-- In July 2004, the SEC adopted Reg SHO, a regulation governing short-selling activities in equity markets.  --> 2004年7月、SECは、株式市場における空売り活動を統制する規制であるReg SHOを採択した。 <!-- Reg SHO contained a pilot program in which stocks in the Russell 3000 index were ranked by trading volume within each exchange and every third one was designated as a pilot stock.  --> Reg SHOには、Russell 3000指数の株式が各取引所内で取引量によってランク付けされ、3つおきに1つがパイロット株式として指定されるパイロットプログラムが含まれていた。 <!-- From 2 May 2005 to 6 August 2007, short sales on pilot stocks were exempted from price tests, including the tick test for exchange-listed stocks and the bid test for NASDAQ National Market stocks. --> 2005年5月2日から2007年8月6日まで、パイロット株式に対する空売りは、取引所上場株式のチックテストやNASDAQナショナルマーケット株式のビッドテストを含む価格テストの対象外とされた。</p>
<!-- In its initial order, the SEC stated that “the Pilot will allow [the SEC] to study trading behavior in the absence of a short sale price test.”  -->
<p>最初の命令で、SECは「パイロットは、[SEC]が空売り価格テストのない状況での取引行動を研究することを可能にする」と述べている。 <!-- The SEC’s plan was to “examine, among other things, the impact of price tests on market quality (including volatility and liquidity), whether any price changes are caused by short selling, costs imposed by a price test, and the use of alternative means to establish short positions.” --> SECの計画は、「価格テストが市場の質（ボラティリティや流動性を含む）に与える影響、価格変動が空売りによって引き起こされるかどうか、価格テストによって課されるコスト、および空売りポジションを確立するための代替手段の使用」などを調査することであった。</p>
<!-- ### 19.2.1 The SHO pilot sample -->
<section id="shoパイロットサンプル" class="level3" data-number="11.2.1"><h3 data-number="11.2.1" class="anchored" data-anchor-id="shoパイロットサンプル">
<span class="header-section-number">11.2.1</span> SHOパイロットサンプル</h3>
<!-- The assignment mechanism in the Reg SHO experiment is unusually transparent, even by the standards of natural experiments. -->
<p>Reg SHO実験における割当メカニズムは、自然実験の基準に照らしても、極めて透明性が高い。 <!-- Nonetheless care is needed to identify the treatment and control firms and we believe it is instructive to walk through the steps needed to do so, as we do in this section.  --> しかしながら、処置群および対照群の企業を特定する際には慎重を要する。本節では、その手順を具体的に示すことが有益であると考える。 <!-- (Readers who find the code details tedious could easily skip ahead to Section 19.2.3 on a first reading.  --> （コードの詳細を煩雑に感じる読者は、初回の読解時には 19.2.3 節 に進むことも可能である。 <!-- We say “first reading” because there are subtle issues with natural experiments that this section helps to highlight, so it may be worth revisiting this section once you have read the later material.) --> ただし、「初回の読解」と述べたのは、自然実験には微妙な論点が含まれており、本節がそれらを明確にする助けとなるためである。後の内容を読んだ後に本節に戻ることも有意義であろう。）</p>
<!-- The SEC’s website provides data on the names and tickers of the Reg SHO pilot firms.  -->
<p>SECのウェブサイトでは、Reg SHOパイロット企業の名称およびティッカーシンボルに関するデータが提供されている。 <!-- These data have been parsed and included as the sho_tickers data set in the farr package. --> これらのデータは解析され、<code>farr</code>パッケージの<code>sho_tickers</code>データセットとして組み込まれている。</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_tickers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 986 × 2
   ticker co_name                 
   &lt;chr&gt;  &lt;chr&gt;                   
 1 A      AGILENT TECHNOLOGIES INC
 2 AAI    AIRTRAN HOLDINGS INC    
 3 AAON   AAON INC                
 4 ABC    AMERISOURCEBERGEN CORP  
 5 ABCO   ADVISORY BOARD CO       
 6 ABCW   ANCHOR BANCORP INC      
 7 ABGX   ABGENIX INC             
 8 ABK    AMBAC FINANCIAL GRP INC 
 9 ABMD   ABIOMED INC             
10 ABR    ARBOR REALTY TRUST INC  
# ℹ 976 more rows</code></pre>
</div>
</div>
<!-- However, these are just the pilot firms and we need to use other sources to obtain the identities of the control firms.  -->
<p>しかし、これらはあくまでパイロット企業に関するものであり、対照群の企業を特定するには別の情報源を利用する必要がある。 <!-- It might seem perverse for the SEC to have published lists of treatment stocks, but no information on control stocks.4  --> SECが処置群の銘柄リストを公表していながら、対照群に関する情報を提供していないことは、一見すると不可解に思われるかもしれない。 <!-- One explanation for this choice might be that, because special action (i.e., elimination of price tests) was only required for the treatment stocks (for the control stocks, it was business as usual), no lists of controls were needed for the markets to implement the pilot. --> ひとつの説明として、特別な措置（すなわち、価格テストの撤廃）が処置群の銘柄に対してのみ適用されたため、対照群の銘柄については市場において通常の取引が継続されることになり、パイロット実験の実施にあたって対照群のリストを作成する必要がなかった可能性がある。 <!-- Additionally, because the SEC had a list of the control stocks that it would use in its own statistical analysis, it had no reason to publish lists for this purpose.  --> さらに、SEC自身が統計分析を行う際に対照群のリストを保有していたため、公表する必要がなかったとも考えられる。 <!-- Fortunately, while the SEC did not identify the control stocks, it provides enough information for us to do so, as we do below. --> 幸いなことに、SECは対照群の銘柄を明示的には特定していないものの、それを特定するために十分な情報を提供しており、本節ではその方法を示す。</p>
<!-- First, we know that the pilot stocks were selected from the Russell 3000, the component stocks of which are found in the sho_r3000 data set from the farr package. -->
<p>まず、パイロット銘柄は Russell 3000 の構成銘柄から選定されたことが分かっている。これらの構成銘柄は、<code>farr</code>パッケージの<code>sho_r3000</code>データセットに含まれている。</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,000 × 2
   russell_ticker russell_name            
   &lt;chr&gt;          &lt;chr&gt;                   
 1 A              AGILENT TECHNOLOGIES INC
 2 AA             ALCOA INC               
 3 AACC           ASSET ACCEPTANCE CAPITAL
 4 AACE           ACE CASH EXPRESS INC    
 5 AAI            AIRTRAN HOLDINGS INC    
 6 AAON           AAON INC                
 7 AAP            ADVANCE AUTO PARTS INC  
 8 AAPL           APPLE COMPUTER INC      
 9 ABAX           ABAXIS INC              
10 ABC            AMERISOURCEBERGEN CORP  
# ℹ 2,990 more rows</code></pre>
</div>
</div>
<!-- While the Russell 3000 contains 3,000 securities, the SEC and Black et al. (2019) tell us that, in constructing the pilot sample, the SEC excluded 32 stocks in the Russell 3000 index that, as of 25 June 2004, were not listed on the Nasdaq National Market, NYSE, or AMEX “because short sales in these securities are currently not subject to a price test.”  -->
<p>Russell 3000には3,000銘柄が含まれているが、SECおよびBlack et al.&nbsp;(2019)によると、パイロットサンプルの構築にあたり、SECは以下の基準で一部の銘柄を除外している。 まず、2004年6月25日時点でNasdaq National Market, NYSE, AMEX に上場していなかった32銘柄を除外している。 SECによれば、これらの銘柄は「現時点で空売りに対する価格テストの適用対象外である」ため、パイロットサンプルから除外された。 <!-- The SEC also excluded 12 stocks that started trading after 30 April 2004 due to IPOs or spin-offs. And, from Black et al. (2019), we know there were two additional stocks that stopped trading after 25 June 2004 but before the SEC constructed its sample on 28 June 2004.  --> さらに、2004年4月30日以降に IPO または スピンオフ により新規上場した 12銘柄 も除外された。 また、Black et al.&nbsp;(2019) によると、2004年6月25日以降、SECがサンプルを構築する2004年6月28日までの間に取引が停止した2銘柄 も除外されている。 <!-- We can get the data for each of these criteria from CRSP, but we need to first merge the Russell 3000 data with CRSP to identify the right PERMNO for each security.  --> これらの基準に該当する銘柄を特定するためには、CRSP のデータを活用する必要がある。ただし、その前にRussell 3000のデータとCRSPを統合し、各銘柄に対応する適切な PERMNO を特定する必要がある。 <!-- For this purpose, we will use data from the five CRSP tables below: --> そのために、以下のCRSPの5つのデータテーブルを用いる。</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">PostgreSQL</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">parquet</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html">Postgres</a></span><span class="op">(</span><span class="op">)</span>, bigint <span class="op">=</span> <span class="st">"integer"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"mse"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">msf</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"msf"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stocknames</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"stocknames"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dseexchdates</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"dseexchdates"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ccmxpf_lnkhist</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"ccmxpf_lnkhist"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"mse"</span><span class="op">)</span></span>
<span><span class="va">msf</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"msf"</span><span class="op">)</span></span>
<span><span class="va">stocknames</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"stocknames"</span><span class="op">)</span></span>
<span><span class="va">dseexchdates</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"dseexchdates"</span><span class="op">)</span></span>
<span><span class="va">ccmxpf_lnkhist</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"ccmxpf_lnkhist"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<!-- One thing we note is that some of the tickers from the Russell 3000 sample append the class of stock to the ticker. We can detect these cases by looking for a dot (.) using regular expressions. Because a dot has special meaning in regular expressions (regex), we need to escape it using a backslash (\). (For more on regular expressions, see Chapter 9 and references cited there.) Because a backslash has a special meaning in strings in R, we need to escape the backslash itself to tell R that we mean a literal backslash. In short, we use the regex \\. to detect dots in strings. -->
<p>ラッセル3000のサンプルに含まれる一部のティッカーは、ティッカーに株式のクラスを付加している。このようなケースを検出するには、正規表現（regex）を使用してドット（<code>.</code>）を探す。ただし、ドットは正規表現において特別な意味を持つため、バックスラッシュ（<code>\</code>）を使ってエスケープする必要がある。Rの文字列内では、バックスラッシュ自体にも特別な意味があるため、入力通りにバックスラッシュを表現するには、さらにバックスラッシュをエスケープしなければならない。したがって、ドットを検出するには、正規表現として “<code>\\.</code>” を使用する。</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">russell_ticker</span>, <span class="st">"\\."</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 2
   russell_ticker russell_name           
   &lt;chr&gt;          &lt;chr&gt;                  
 1 AGR.B          AGERE SYSTEMS INC      
 2 BF.B           BROWN FORMAN CORP      
 3 CRD.B          CRAWFORD &amp; CO          
 4 FCE.A          FOREST CITY ENTRPRS    
 5 HUB.B          HUBBELL INC            
 6 JW.A           WILEY JOHN &amp; SONS INC  
 7 KV.A           K V PHARMACEUTICAL CO  
 8 MOG.A          MOOG INC               
 9 NMG.A          NEIMAN MARCUS GROUP INC
10 SQA.A          SEQUA CORPORATION      
11 TRY.B          TRIARC COS INC         
12 VIA.B          VIACOM INC             </code></pre>
</div>
</div>
<!-- In these cases, CRSP takes a different approach.  -->
<p>このような場合、CRSPは異なるアプローチを取る。 <!-- For example, where the Russell 3000 sample has AGR.B, CRSP has ticker equal to AGR and shrcls equal to B. --> 例えば、ラッセル3000のサンプルでは AGR.B となっているが、CRSPではティッカーが AGR、株式クラス（shrcls）が B となっている。</p>
<!-- The other issue is that some tickers from the Russell 3000 data have the letter E appended to what CRSP shows as just a four-letter ticker. -->
<p>もう一つの問題は、ラッセル3000のデータに含まれる一部のティッカーが、CRSPでは4文字のティッカーとして表示されるのに対し、末尾に<code>E</code>が付加されているケースがあることである。</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">str_length</span><span class="op">(</span><span class="va">russell_ticker</span><span class="op">)</span> <span class="op">==</span> <span class="fl">5</span>,</span>
<span>         <span class="fu">str_sub</span><span class="op">(</span><span class="va">russell_ticker</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">==</span> <span class="st">"E"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  russell_ticker russell_name      
  &lt;chr&gt;          &lt;chr&gt;             
1 CVNSE          COVANSYS CORP     
2 SONSE          SONUS NETWORKS INC
3 SPSSE          SPSS INC          
4 VXGNE          VAXGEN INC        </code></pre>
</div>
</div>
<!-- A curious reader might wonder how we identified these two issues with tickers, and how we know that they are exhaustive of the issues in the data. We explore these questions in the exercises at the end of this section. -->
<p>好奇心のある読者は、これら2つのティッカーの問題をどのように特定したのか、また、それらがデータ内の問題を網羅しているとどのように判断したのか疑問に思うかもしれない。これらの問いについては、本節の演習で詳しく探求する。</p>
<!-- To address these issues, we create two functions: one (`clean_ticker()`) to “clean” each ticker so that it can be matched with CRSP, and one (`get_shrcls()`) to extract the share class (if any) specified in the Russell 3000 data. -->
<p>これらの問題に対応するために、2つの関数を作成する。1つは、ティッカーをCRSPと照合できるように“クリーン”にする<code>clean_ticker()</code>であり、もう1つは、ラッセル3000データ内で指定されている株式クラス（もしあれば）を抽出する<code>get_shrcls()</code>である。</p>
<!-- Both functions use a regular expression to match cases where the text ends with either “A” or “B” (`[AB]$` in regex) preceded by the a dot (`\\.` in regex, as discussed above). The expression uses capturing parentheses (i.e., `(` and `)`) to capture the text before the dot from the beginning of the string `(^(.*))` to the dot and to capture the letter “A” or “B” at the end (`([AB])$`). -->
<p>どちらの関数も、正規表現を用いて、テキストがドット（<code>\\.</code>）の後にAまたはBで終わるケースを検出する（正規表現では<code>[AB]$</code>）。 この表現では、キャプチャ用の括弧( <code>(</code> と <code>)</code> )を使用し、文字列の先頭からドットまでの部分を <code>(^(.*))</code> で、末尾のAまたはBを<code>([AB])$</code>でキャプチャする。</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">regex</span> <span class="op">&lt;-</span> <span class="st">"^(.*)\\.([AB])$"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The `clean_ticker()` function uses `case_when()`, which first handles cases with an E at the end of five-letter tickers, then applies the regex to extract the “clean” ticker (the first captured text) from cases matching `regex`. Finally, the original ticker is returned for all other cases. -->
<p><code>clean_ticker()</code>関数は、<code>case_when()</code>を使用して、5文字のティッカーの末尾にEが付加されているケースを処理し、次に<code>regex</code>に一致するケースから“クリーン”なティッカー（最初にキャプチャされたテキスト）を抽出する。最後に、それ以外のケースでは元のティッカーを返す。</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">clean_ticker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">case_when</span><span class="op">(</span><span class="fu">str_length</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="fu">str_sub</span><span class="op">(</span><span class="va">x</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">==</span> <span class="st">"E"</span> <span class="op">~</span> <span class="fu">str_sub</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>            <span class="fu">str_detect</span><span class="op">(</span><span class="va">x</span>, <span class="va">regex</span><span class="op">)</span> <span class="op">~</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">x</span>, <span class="va">regex</span>, <span class="st">"\\1"</span><span class="op">)</span>,</span>
<span>            .default <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The `get_shrcls()` function extracts the second capture group from the regex (the first value returned by `str_match()` is the complete match, the second value is the first capture group, so we use `[, 3]` to get the second capture group). -->
<p><code>get_shrcls()</code>関数は、正規表現から2番目のキャプチャグループを抽出する（<code>str_match()</code>が返す最初の値は完全な一致、2番目の値は最初のキャプチャグループであるため、2番目のキャプチャグループを取得するために<code>[, 3]</code>を使用する）。</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_shrcls</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">str_match</span><span class="op">(</span><span class="va">x</span>, <span class="va">regex</span><span class="op">)</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- We can use `clean_ticker()` and `get_shrcls()` to construct `sho_r3000_tickers`. -->
<p><code>clean_ticker()</code>と<code>get_shrcls()</code>を使用して、<code>sho_r3000_tickers</code>を構築することができる。</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_tickers</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">russell_ticker</span>, <span class="va">russell_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ticker <span class="op">=</span> <span class="fu">clean_ticker</span><span class="op">(</span><span class="va">russell_ticker</span><span class="op">)</span>,</span>
<span>         shrcls <span class="op">=</span> <span class="fu">get_shrcls</span><span class="op">(</span><span class="va">russell_ticker</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sho_r3000_tickers</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">russell_ticker</span> <span class="op">!=</span> <span class="va">ticker</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 4
   russell_ticker russell_name            ticker shrcls
   &lt;chr&gt;          &lt;chr&gt;                   &lt;chr&gt;  &lt;chr&gt; 
 1 AGR.B          AGERE SYSTEMS INC       AGR    B     
 2 BF.B           BROWN FORMAN CORP       BF     B     
 3 CRD.B          CRAWFORD &amp; CO           CRD    B     
 4 CVNSE          COVANSYS CORP           CVNS   &lt;NA&gt;  
 5 FCE.A          FOREST CITY ENTRPRS     FCE    A     
 6 HUB.B          HUBBELL INC             HUB    B     
 7 JW.A           WILEY JOHN &amp; SONS INC   JW     A     
 8 KV.A           K V PHARMACEUTICAL CO   KV     A     
 9 MOG.A          MOOG INC                MOG    A     
10 NMG.A          NEIMAN MARCUS GROUP INC NMG    A     
11 SONSE          SONUS NETWORKS INC      SONS   &lt;NA&gt;  
12 SPSSE          SPSS INC                SPSS   &lt;NA&gt;  
13 SQA.A          SEQUA CORPORATION       SQA    A     
14 TRY.B          TRIARC COS INC          TRY    B     
15 VXGNE          VAXGEN INC              VXGN   &lt;NA&gt;  
16 VIA.B          VIACOM INC              VIA    B     </code></pre>
</div>
</div>
<!-- Now that we have “clean” tickers, we can merge with CRSP. The following code proceeds in two steps. First, we create `crsp_sample`, which contains the `permno`, `ticker`, and `shrcls` values applicable on `2004-06-25`, the date on which the Russell 3000 that the SEC used was created. -->
<p>これで“クリーン”なティッカーを取得したので、CRSPと結合することができる。以下のコードは2つのステップで進行する。まず、SECが使用したRussell 3000が作成された日である<code>2004-06-25</code>に適用される<code>permno</code>、<code>ticker</code>、<code>shrcls</code>の値を含む<code>crsp_sample</code>を作成する。</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">crsp_sample</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">stocknames</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>test_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2004-06-25"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">test_date</span> <span class="op">&gt;=</span> <span class="va">namedt</span>, <span class="va">test_date</span> <span class="op">&lt;=</span> <span class="va">nameenddt</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">permno</span>, <span class="va">permco</span>, <span class="va">ticker</span>, <span class="va">shrcls</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Second, we merge `sho_r3000_tickers` with `crsp_sample` using `ticker` and then use `filter()` to retain cases where, if a share class is specified in the SEC-provided ticker, it matches the one row in CRSP with that share class, while retaining all rows where no share class is specified in the SEC-provided ticker. -->
<p>次に、<code>ticker</code>を使用して<code>sho_r3000_tickers</code>と<code>crsp_sample</code>を結合し、<code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code>を使用して、SECが提供したティッカーに株式クラスが指定されている場合、その株式クラスに一致するCRSPの1行を保持し、SECが提供したティッカーに株式クラスが指定されていない場合はすべての行を保持する。</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_merged</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000_tickers</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">crsp_sample</span>, by <span class="op">=</span> <span class="st">"ticker"</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_crsp"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">shrcls</span> <span class="op">==</span> <span class="va">shrcls_crsp</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">shrcls</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">russell_ticker</span>, <span class="va">permco</span>, <span class="va">permno</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Unfortunately, this approach results in some tickers being matched to multiple PERMNO values. -->
<p>残念ながら、このアプローチでは、いくつかのティッカーが複数のPERMNO値にマッチする結果となる。</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_merged</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">russell_ticker</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- In each case, these appear to be cases where there are multiple securities (permno values) for the same company (permco value). To choose the security that is the one most likely included in the Russell 3000 index used by the SEC, we will keep the one with the greatest dollar trading volume for the month of June 2004. We collect the data on dollar trading volumes in the data frame trading_vol. -->
<p>各ケースでは、同じ企業（<code>permco</code>値）に対して複数の証券（<code>permno</code>値）が存在するようである。SECが使用したRussell 3000指数に最も含まれていると考えられる証券を選択するために、2004年6月の最も大きな取引量を持つ証券を保持することにする。取引量に関するデータを<code>trading_vol</code>データフレームに収集する。</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trading_vol</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">msf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="st">"2004-06-30"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>dollar_vol <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">prc</span><span class="op">)</span> <span class="op">*</span> <span class="va">vol</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">permno</span>, <span class="va">dollar_vol</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- We can now make a new version of the table sho_r3000_merged that includes just the permno value with the greatest trading volume for each ticker. -->
<p>これで、各ティッカーに対して最も取引量の多い<code>permno</code>値を含む新しいバージョンの<code>sho_r3000_merged</code>テーブルを作成することができる。</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_merged</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000_tickers</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">crsp_sample</span>, by <span class="op">=</span> <span class="st">"ticker"</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_crsp"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">shrcls</span><span class="op">)</span> <span class="op">|</span> <span class="va">shrcls</span> <span class="op">==</span> <span class="va">shrcls_crsp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">trading_vol</span>, by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">russell_ticker</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dollar_vol</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">dollar_vol</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">russell_ticker</span>, <span class="va">permno</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Black et al. (2019) identify 32 stocks that are not listed on the Nasdaq National Market, NYSE, or AMEX firms “using historical exchange code (exchcd) and Nasdaq National Market Indicator (nmsind) from the CRSP monthly stock file” (in practice, these 32 stocks are smaller Nasdaq-listed stocks).  -->
<p>Black et al.&nbsp;(2019) は、「CRSPの月次株式ファイルからの歴史的な取引所コード（<code>exchcd</code>）とNASDAQナショナルマーケットインジケータ（<code>nmsind</code>）を使用して、Nasdaq National Market、NYSE、AMEXに上場していない32銘柄を特定した」と述べている（実際には、これらの32銘柄は小規模なNasdaq上場銘柄である）。 <!-- However, exchcd and nmsind are not included in the crsp.msf file we use. Black et al. (2019) likely used the CRSP monthly stock file obtained from the web interface provided by WRDS, which often merges in data from other tables. --> しかし、<code>exchcd</code>と<code>nmsind</code>は、私たちが使用している<code>crsp.msf</code>ファイルには含まれていない。Black et al.&nbsp;(2019) は、おそらくWRDSが提供するWebインターフェースから取得したCRSPの月次株式ファイルを使用しており、このファイルは他のテーブルからのデータを結合することが多い。</p>
<!-- Fortunately, we can obtain `nmsind` from the CRSP monthly events file (`crsp.mse`).  -->
<p>幸いなことに、CRSPの月次イベントファイル（<code>crsp.mse</code>）から<code>nmsind</code>を取得することができる。 <!-- This file includes information about delisting events, distributions (such as dividends), changes in NASDAQ information (such as `nmsind`), and name changes. We get data on `nmsind` by pulling the latest observation on `crsp.mse` on or before `2004-06-28` where the event related to NASDAQ status (`event == "NASDIN"`). --> このファイルには、上場廃止イベント、配当などの配布、NASDAQ情報の変更（<code>nmsind</code>など）、名前の変更に関する情報が含まれている。<code>nmsind</code>に関するデータは、<code>2004-06-28</code>以前の<code>crsp.mse</code>の最新の観測値を取得し、NASDAQステータスに関連するイベント（<code>event == "NASDIN"</code>）を取得することで取得できる。</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nmsind_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">mse</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="st">"2004-06-28"</span>, <span class="va">event</span> <span class="op">==</span> <span class="st">"NASDIN"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">permno</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">permno</span>, <span class="va">date</span>, <span class="va">nmsind</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- We can obtain exchcd from the CRSP stock names file (`crsp.stocknames`), again pulling the value applicable on `2004-06-28`.[^5] -->
<p><code>exchcd</code>は、CRSPの株式名ファイル（<code>crsp.stocknames</code>）から取得することができる。再度、<code>2004-06-28</code>に適用される値を取得する。<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">exchcd_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">stocknames</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">exchcd</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>test_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2004-06-28"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">test_date</span>, <span class="va">namedt</span>, <span class="va">nameenddt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">permno</span>, <span class="va">exchcd</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- According to [its website](https://www.sec.gov/rule-release/34-50104), the SEC “also excluded issuers whose initial public offerings commenced after April 30, 2004.”  -->
<p>SECの<a href="https://www.sec.gov/rule-release/34-50104">ウェブサイト</a>によると、「2004年4月30日以降に開始された新規株式公開（IPO）を行った発行体も除外した」という。 <!-- Following Black et al. (2019), we use CRSP data to identify these firms.  --> Black et al.&nbsp;(2019) に従い、これらの企業を特定するためにCRSPデータを使用する。 <!-- Specifically, the table `crsp.dseexchdates` includes the variable `begexchdate`. --> 具体的には、テーブル<code>crsp.dseexchdates</code>には変数<code>begexchdate</code>が含まれている。</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ipo_dates</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">dseexchdates</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">permno</span>, <span class="va">begexchdate</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Finally, it appears that there were stocks listed in the Russell 3000 file likely used by the SEC (created on 2004-06-25) that were delisted prior to 2004-06-28, the date on which the SEC appears to have finalized the sample for its pilot program. We again use crsp.mse to identify these firms. -->
<p>最後に、SECがパイロットプログラムのサンプルを最終的に確定したと思われる2004-06-28より前に上場廃止された銘柄が、SECがおそらく使用したRussell 3000ファイルに含まれていたようである。これらの企業を特定するために、再度<code>crsp.mse</code>を使用する。</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">recent_delistings</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">mse</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">event</span> <span class="op">==</span> <span class="st">"DELIST"</span>, </span>
<span>         <span class="fu">between</span><span class="op">(</span><span class="va">date</span>, <span class="st">"2004-06-25"</span>, <span class="st">"2004-06-28"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>delist_date <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">permno</span>, <span class="va">delist_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Now, we put all these pieces together and create variables nasdaq_small, recent_listing, and delisted corresponding to the three exclusion criteria discussed above. -->
<p>これで、これらの要素を組み合わせて、上記で説明した3つの除外基準に対応する変数<code>nasdaq_small</code>、<code>recent_listing</code>、<code>delisted</code>を作成する。</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_permno</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000_merged</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">nmsind_data</span>, by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">exchcd_data</span>, by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">ipo_dates</span>,   by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">recent_delistings</span>, by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>nasdaq_small <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">nmsind</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">exchcd</span> <span class="op">==</span> <span class="fl">3</span>, <span class="cn">FALSE</span><span class="op">)</span>, </span>
<span>         recent_listing <span class="op">=</span> <span class="va">begexchdate</span> <span class="op">&gt;</span> <span class="st">"2004-04-30"</span>,</span>
<span>         delisted <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">delist_date</span><span class="op">)</span>,</span>
<span>         keep <span class="op">=</span> <span class="op">!</span><span class="va">nasdaq_small</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">recent_listing</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">delisted</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- As can be seen in Table 19.1, we have a final sample of 2954 stocks that we can merge with sho_tickers to create the pilot indicator. -->
<p>表19.1に示すように、パイロット指標を作成するために結合できる2954銘柄の最終サンプルが得られた。</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_permno</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">nasdaq_small</span>, <span class="va">recent_listing</span>, <span class="va">delisted</span>, <span class="va">keep</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_sample</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000_permno</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">keep</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>ticker <span class="op">=</span> <span class="va">russell_ticker</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">sho_tickers</span>, by <span class="op">=</span> <span class="st">"ticker"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>pilot <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">co_name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">ticker</span>, <span class="va">permno</span>, <span class="va">pilot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- As can be seen the number of treatment and control firms in sho_r3000_sample corresponds exactly with the numbers provided in Black et al. (2019, p. 42). -->
<p>表19.1に示すように、<code>sho_r3000_sample</code>の処置群と対照群の企業数は、Black et al.&nbsp;(2019, p.&nbsp;42)で提供された数値と完全に一致している。</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_sample</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">pilot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Finally, we will want to link these data with data from Compustat, which means linking these observations with GVKEYs.  -->
<p>最後に、これらのデータをCompustatのデータとリンクしたいと考えている。つまり、これらの観測値をGVKEYとリンクする必要がある。 <!-- For this, we use ccm_link (as used and discussed in Chapter 7) to produce sho_r3000_gvkeys, the sample we can use in later analysis. --> これには、後の分析で使用できるサンプルである<code>sho_r3000_gvkeys</code>を生成するために、<code>ccm_link</code>（第7章で使用および議論された）を使用する。</p>
<!-- Finally, we will want to link these data with data from Compustat, which means linking these observations with GVKEYs.  -->
<p>最後に、これらのデータをCompustatのデータとリンクしたいと考えている。つまり、これらの観測値をGVKEYとリンクする必要がある。 <!-- For this, we use `ccm_link` (as used and discussed in [Chapter 7]()) to produce `sho_r3000_gvkeys`, the sample we can use in later analysis. --> これには、後の分析で使用できるサンプルである<code>sho_r3000_gvkeys</code>を生成するために、<code>ccm_link</code>（第7章で使用および議論された）を使用する。</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ccm_link</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ccmxpf_lnkhist</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">linktype</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LC"</span>, <span class="st">"LU"</span>, <span class="st">"LS"</span><span class="op">)</span>,</span>
<span>         <span class="va">linkprim</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="st">"P"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>permno <span class="op">=</span> <span class="va">lpermno</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>linkenddt <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">linkenddt</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">linkenddt</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">permno</span>, <span class="va">linkdt</span>, <span class="va">linkenddt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Because we focus on a single “test date”, our final link table includes just two variables: `gvkey` and `permno`.[^6] -->
<p>単一の「テスト日」に焦点を当てるため、最終的なリンクテーブルには<code>gvkey</code>と<code>permno</code>の2つの変数のみが含まれる。<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gvkeys</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ccm_link</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>test_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2004-06-28"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">test_date</span>, <span class="va">linkdt</span>, <span class="va">linkenddt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">permno</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Finally, we can add `gvkey` to `sho_r3000_sample` to create `sho_r3000_gvkeys`. -->
<p>最後に、<code>sho_r3000_sample</code>に<code>gvkey</code>を追加して<code>sho_r3000_gvkeys</code>を作成することができる。</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_gvkeys</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000_sample</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">gvkeys</span>, by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sho_r3000_gvkeys</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- To better understand the potential issues with constructing the `pilot` indicator variable, it is useful to compare the approach above with that taken in Fang et al. ([2016](references.html#ref-Fang:2016uy)).  -->
<p><code>pilot</code>指標変数を構築する際の潜在的な問題をよりよく理解するために、上記のアプローチとFang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>)のアプローチを比較することが有益である。 <!-- To construct `sho_data` as Fang et al. ([2016](references.html#ref-Fang:2016uy)) do, we use `fhk_pilot` from the `farr` package.[7](#fn7) We compare `sho_r3000_sample` and `sho_r3000_gvkeys` with `sho_data` in the exercises below. --> Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>)のように<code>sho_data</code>を構築するために、<code>farr</code>パッケージから<code>fhk_pilot</code>を使用する。以下の演習で、<code>sho_r3000_sample</code>と<code>sho_r3000_gvkeys</code>を<code>sho_data</code>と比較する。</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">fhk_pilot</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">pilot</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">fhk_pilot</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"pilot"</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercises" class="level3" data-number="11.2.2"><h3 data-number="11.2.2" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">11.2.2</span> Exercises</h3>
<!-- 1. Before running the following code, can you tell from output above how many rows this query will return?  -->
<ol type="1">
<li>以下のコードを実行する前に、上記の出力からこのクエリが何行を返すかを判断できますか？ <!-- What is this code doing?  --> このコードは何をしているのか？ <!-- At what stage would code like this have been used in process of creating the sample above?  --> このようなコードは、上記のサンプルを作成する過程でどの段階で使用されたか？ <!-- Why is code like this not included above? --> なぜこのようなコードは上記に含まれていないのか？</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">anti_join</span><span class="op">(</span><span class="va">crsp_sample</span>, <span class="fu">join_by</span><span class="op">(</span><span class="va">russell_ticker</span> <span class="op">==</span> <span class="va">ticker</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- 2. Focusing on the values of `ticker` and `pilot` in `fhk_pilot`, what differences do you observe between `fhk_pilot` and `sho_r3000_sample`? -->
<ol start="2" type="1">
<li>
<code>fhk_pilot</code>の<code>ticker</code>と<code>pilot</code>の値に焦点を当てると、<code>fhk_pilot</code>と<code>sho_r3000_sample</code>の間にどのような違いがあるかを観察しなさい。 <!-- What do you believe is the underlying cause for these discrepancies? --> これらの相違の根本的な原因は何だと思うか？</li>
</ol>
<!-- 3. What do the following observations represent?  --><ol start="3" type="1">
<li>以下の観察は何を表しているか？ <!-- Choose a few observations from this output and examine whether these reveal issues in the `sho_r3000_sample` or in `fhk_pilot`. --> この出力からいくつかの観察を選択し、これらが<code>sho_r3000_sample</code>または<code>fhk_pilot</code>に問題を示しているかどうかを調べなさい。</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_r3000_sample</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">fhk_pilot</span>, by <span class="op">=</span> <span class="st">"ticker"</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_ours"</span>, <span class="st">"_fhk"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">permno_ours</span> <span class="op">!=</span> <span class="va">permno_fhk</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- 4. In constructing the `pilot` indicator, FHK omit cases (`gvkey` values) where there is more than one distinct value for the indicator.  -->
<ol start="4" type="1">
<li>
<code>pilot</code>指標を構築する際、FHKは、指標の値が複数ある場合（<code>gvkey</code>値）にはケースを省略している。 <!-- A question is: Who are these firms?  --> 質問は：これらの企業は誰か？ <!-- Why is there more than one value for `pilot` for these firms?  --> これらの企業に対して<code>pilot</code>に複数の値があるのはなぜか？ <!-- And does omission of these make sense?  --> そして、これらを省略することは理にかなっているか？ <!-- (*Hint*: Identify duplicates in `fhk_pilot` and compare `sho_r3000_gvkeys` for these firms.) --> （<em>ヒント</em>：<code>fhk_pilot</code>の重複を特定し、これらの企業について<code>sho_r3000_gvkeys</code>を比較する。）</li>
</ol>
<!-- 5. What issue is implicit in the output from the code below?  --><ol start="5" type="1">
<li>以下のコードの出力には何の問題が含まれているか？ <!-- How could you fix this issue?  --> この問題をどのように修正できるか？ <!-- Would you expect a fix for this issue to significantly affect the regression results? Why or why not? --> この問題の修正が回帰結果に大きな影響を与えると予想されるか？その理由は何か？</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">ticker</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ###  Early studies of Reg SHO -->
</section><section id="reg-shoの初期の研究" class="level3" data-number="11.2.3"><h3 data-number="11.2.3" class="anchored" data-anchor-id="reg-shoの初期の研究">
<span class="header-section-number">11.2.3</span> Reg SHOの初期の研究</h3>
<!-- The first study of the effects of Reg SHO was conducted by the SEC’s own Office of Economic Analysis.  -->
<p>Reg SHOの影響に関する最初の研究は、SECの経済分析局によって行われた。 <!-- [The SEC study](https://www.sec.gov/news/studies/2007/regshopilot020607.pdf) examines the “effect of pilot on short selling, liquidity, volatility, market efficiency, and extreme price changes” [p. 86]. --> <a href="https://www.sec.gov/news/studies/2007/regshopilot020607.pdf">SECの研究</a>は、「パイロットがショートセール、流動性、ボラティリティ、市場効率、および極端な価格変動に与える影響」を調査している[p.&nbsp;86]。</p>
<!-- The authors of the 2007 SEC study “find that price restrictions reduce the volume of executed short sales relative to total volume, indicating that price restrictions indeed act as a constraint to short selling. -->
<p>2007年のSECの調査の著者らは、「価格規制は、総取引量に対する空売りの実行量を減少させることを確認しており、これは価格規制が実際に空売りの制約として機能していることを示している」と述べている。 <!-- However, in neither market do we find significant differences in short interest across pilot and control stocks.  --> しかし、どの市場においても、パイロット銘柄とコントロール銘柄の間で空売り残高に有意な差は見られなかった。 <!-- … We find no evidence that short sale price restrictions in equities have an impact on option trading or open interest.  --> また、株式の空売りに対する価格規制がオプション取引や建玉に影響を与える証拠も見つからなかった。 <!-- … We find that quoted depths are augmented by price restrictions but realized liquidity is unaffected.  --> さらに、気配値の厚み（quoted depth）は価格規制によって増加するものの、実現流動性には影響を与えないことが分かった。 <!-- Further, we find some evidence that price restrictions dampen short term within-day return volatility, but when measured on average, they seem to have no effect on daily return volatility.” --> 加えて、価格規制が日中の短期的なリターンの変動を抑える証拠はあるものの、平均的に測定すると、日次リターンの変動性には影響を与えないようであることが示された。</p>
<!-- The SEC researchers conclude “based on the price reaction to the initiation of the pilot, we find limited evidence that the tick test distorts stock prices—on the day the pilot went into effect, Listed Stocks in the pilot sample underperformed Listed Stocks in the control sample by approximately 24 basis points.  -->
<!-- However, the pilot and control stocks had similar returns over the first six months of the pilot.” -->
<p>SECの研究者は次のように結論づけている。「パイロット・プログラムの開始に対する価格の反応に基づくと、ティック・テストが株価を歪めるという証拠は限定的である。パイロット・プログラムが発効した当日、パイロット・サンプルに含まれる上場株は、対照サンプルに含まれる上場株と比べて約24ベーシスポイント低いパフォーマンスを示した。しかし、パイロット株と対照株のリターンは、プログラム開始から最初の6か月間で類似していた。」</p>
<!-- In summary, it seems fair to say that the SEC found that exemption from price tests had relatively limited effect on the market outcomes of interest, with no apparent impact on several outcomes. -->
<p>要約すると、SECは価格テストの免除が市場の関心のある結果に対して比較的限定的な影響しか与えず、いくつかの結果には明らかな影響がなかったと判断したと言える。</p>
<!-- @Alexander:2008th [p.84] “examine how price tests affect trader behavior and market quality, which are areas of interest given by the [SEC] in evaluating these tests.” @Alexander:2008th [p.86] find that NYSE pilot stocks have similar spreads, but smaller trade sizes, more short trades, more short volume, and smaller ask depths.  -->
<!-- With regard to Nasdaq, @Alexander:2008th [p.86] find that the removed “bid test is relatively inconsequential.” -->
<p><span class="citation" data-cites="Alexander:2008th">Alexander and Peterson (<a href="#ref-Alexander:2008th" role="doc-biblioref">2008, 84</a>)</span> は、「価格テストがトレーダーの行動や市場の質にどのような影響を与えるかを調査しており、これはSECがこれらのテストを評価する際に関心を持っている領域である」と述べている。<span class="citation" data-cites="Alexander:2008th">Alexander and Peterson (<a href="#ref-Alexander:2008th" role="doc-biblioref">2008, 86</a>)</span> によれば、NYSEのパイロット株はスプレッドが類似しているものの、取引サイズが小さく、ショート取引が増え、ショート取引量が多く、アスクの深さが小さくなっているとしている。 Nasdaqに関して、<span class="citation" data-cites="Alexander:2008th">Alexander and Peterson (<a href="#ref-Alexander:2008th" role="doc-biblioref">2008, 86</a>)</span> は「撤廃されたビッド・テストの影響は比較的軽微である」と指摘している。</p>
<!-- @Diether:2009vu [p.37] find that “while short-selling activity increases both for NYSE- and Nasdaq-listed Pilot stocks, returns and volatility at the daily level are unaffected.” -->
<p><span class="citation" data-cites="Diether:2009vu">Diether, Lee, and Werner (<a href="#ref-Diether:2009vu" role="doc-biblioref">2009, 37</a>)</span> は、「NYSEおよびNasdaqに上場するパイロット株では空売り活動が増加するものの、日次レベルでのリターンやボラティリティには影響がない」と述べている。</p>
<!-- ###  Discussion questions and exercises -->
</section><section id="ディスカッション課題と練習問題" class="level3" data-number="11.2.4"><h3 data-number="11.2.4" class="anchored" data-anchor-id="ディスカッション課題と練習問題">
<span class="header-section-number">11.2.4</span> ディスカッション課題と練習問題</h3>
<!-- 1. Earlier we identified one feature of a randomized controlled trial (RCT) as that “proposed analyses are specified in advance”, as in a registered reports process.  -->
<!-- Why do you think the SEC did not use a registered report for its 2007 paper?  -->
<!-- Do you think the analyses of the SEC would be more credible if conducted as part of a registered reports process? Why or why not? -->
<ol type="1">
<li>先ほど、ランダム化比較試験（RCT）の特徴の一つとして、「提案された分析が事前に指定される」ことを挙げた。これは登録報告（registered reports）のプロセスと同様である。 SECが2007年の論文で登録報告を使用しなかったのはなぜだと思うか。 また、SECの分析が登録報告プロセスの一環として実施されていれば、より信頼性が高まったと思うか。その理由も含めて説明せよ。</li>
</ol>
<!-- 2. Do you have concerns that the results @Alexander:2008th have been p-hacked? What factors increase or reduce your concerns in this regard? --><ol start="2" type="1">
<li>
<span class="citation" data-cites="Alexander:2008th">Alexander and Peterson (<a href="#ref-Alexander:2008th" role="doc-biblioref">2008</a>)</span> の結果がp-hackedされた可能性について懸念があるか。この点に関して懸念を増大させる要因と減少させる要因は何か。</li>
</ol>
<!-- 3. Evaluate the hypotheses found in the section of @Diether:2009vu entitled *Testable Hypotheses* with particular sensitivity to concerns about HARKing. What kind of expertise is necessary in evaluating hypotheses in this way? --><ol start="3" type="1">
<li>
<span class="citation" data-cites="Diether:2009vu">Diether, Lee, and Werner (<a href="#ref-Diether:2009vu" role="doc-biblioref">2009</a>)</span> の<strong>検証可能な仮説</strong>というセクションに見られる仮説をHARKingに関する懸念に特に敏感に評価せよ。このような仮説を評価する際にはどのような専門知識が必要か。</li>
</ol>
<!-- 4. How might the SEC have conducted Reg SHO as part of a registered reports process open to outside research teams, such as @Alexander:2008th and @Diether:2009vu? How might such a process have been run? What challenges would such a process face? --><ol start="4" type="1">
<li>SECは、<span class="citation" data-cites="Alexander:2008th">Alexander and Peterson (<a href="#ref-Alexander:2008th" role="doc-biblioref">2008</a>)</span> や@Diether:2009vu のような外部研究チームに公開された登録報告プロセスの一環としてReg SHOを実施することができたか。そのようなプロセスはどのように実施されたか。そのようなプロセスはどのような課題に直面するか。</li>
</ol>
<!-- ## Analysing natural experiments --></section></section><section id="自然実験の分析" class="level2" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="自然実験の分析">
<span class="header-section-number">11.3</span> 自然実験の分析</h2>
<!-- Both Alexander and Peterson ([2008](references.html#ref-Alexander:2008th)) and Diether et al. ([2009](references.html#ref-Diether:2009vu)) use the difference-in-differences estimator (“DiD”) of the causal effect that we saw in [Chapter 3](reg-basics.html). The typical approach to DiD involves estimating a regression of the following form: -->
<p><span class="citation" data-cites="Alexander:2008th">Alexander and Peterson (<a href="#ref-Alexander:2008th" role="doc-biblioref">2008</a>)</span> と <span class="citation" data-cites="Diether:2009vu">Diether, Lee, and Werner (<a href="#ref-Diether:2009vu" role="doc-biblioref">2009</a>)</span> は、<a href="reg-basics.html">第3章</a>で見た因果効果の差分の差推定量（“DiD”）を使用している。DiDの典型的なアプローチは、以下の形式の回帰を推定することを含む。</p>
<p><span class="math display">
\begin{aligned}
Y_{it} = &amp;\beta_0 + \beta_1 \times POST_t + \beta_2 \times TREAT _i + \\
&amp;\beta _3 \times POST_t \times TREAT_i + \varepsilon_{it}
\end{aligned}
</span></p>
<!-- In this specification, the estimated treatment effect is given by the fitted coefficient $\hat{\beta} _3$ . -->
<p>このモデルで、推定された処置効果は、推定された係数 <span class="math inline">\hat{\beta} _3</span> によって与えられる。</p>
<!-- While DiD is clearly popular among researchers in economics and adjacent fields, it is important to note that it is not obvious that it is the best choice in every experimental setting and that credible alternatives exist. -->
<p>DiDは、経済学や関連分野の研究者の間で明らかに人気があるが、すべての実験設定で最良の選択肢であるとは明らかではなく、信頼性のある代替手法が存在することに注意することが重要である。</p>
<!-- Another approach would be to limit the sample to the post-treatment period and estimate the following regression: -->
<p>別のアプローチは、サンプルを処置後の期間に限定し、以下の回帰を推定することである。</p>
<p><span class="math display">
Y_{it} = \beta_0 + \beta_1 \times TREAT_i + \varepsilon_{it}
</span></p>
<!-- In this specification, the estimated treatment effect is given by the fitted coefficient $\hat{\beta}_1$ .  -->
<p>このモデルで、推定された処置効果は、推定された係数 <span class="math inline">\hat{\beta}_1</span> によって与えられる。 <!-- This approach is common in drug trials, which are typically conducted as RCTs.  --> このアプローチは、通常RCTとして実施される薬物試験で一般的である。 <!-- For example, in the paxlovid trial “participants were randomised 1:1, with half receiving paxlovid and the other half receiving a placebo orally every 12 hours for five days.  --> たとえば、paxlovid試験では、「参加者は1:1で無作為に割り付けられ、半分はpaxlovidを、もう半分は5日間12時間ごとに経口でプラセボを受け取った。」 <!-- Of those who were treated within three days of symptom onset, 0.8% (3/389) of patients who received paxlovid were admitted to hospital up to day 28 after randomization, with no deaths.  --> 「症状発現後3日以内に治療を受けた患者のうち、paxlovidを受け取った患者の0.8%（3/389）が入院し、死亡者はいなかった。」 <!-- In comparison, 7% (27/385) of patients who received placebo were admitted, with seven deaths.” ([Mahase, 2021, p. 1](references.html#ref-Mahase:2021tz)).  --> 「対照群の患者のうち、7%（27/385）が入院し、7人が死亡した。」(<a href="references.html#ref-Mahase:2021tz">Mahase, 2021, p.&nbsp;1</a>)。 <!-- For the hospital admission outcome, it would have been possible to incorporate prior hospitalization rates in a difference-in-differences analysis, but this would only make sense if hospitalization rates in one period had a high predictive power for subsequent hospitalization rates.[^8] --> 病院入院の結果については、差分の差分（difference-in-differences）分析に過去の入院率を組み込むことも可能であった。しかし、これはある期間の入院率がその後の入院率を高い精度で予測できる場合にのみ意味をなす。[^8]</p>
<!-- Yet another approach would include pre-treatment values of the outcome variable as a control: -->
<p>もう1つのアプローチは、処置前の結果変数の値を制御変数として含めることである。</p>
<p><span class="math display">
Y_{it} = \beta_0 + \beta_1 \times TREAT _i + \beta_2 \times Y_{i,t-1} + \varepsilon_{it}
</span></p>
<!-- To evaluate each of these approaches, we can use simulation analysis. The following analysis is somewhat inspired by Frison and Pocock ([1992](references.html#ref-Frison:1992te)), who use different assumptions about their data more appropriate to their (medical) setting and who focus on mathematical analysis instead of simulations. -->
<p>これらのアプローチを評価するために、シミュレーション分析を使用することができる。以下の分析は、Frison and Pocock (<a href="references.html#ref-Frison:1992te">1992</a>)に触発されたもので、彼らは（医学的な）設定に適した異なるデータの仮定を使用し、数学的な分析に焦点を当てている。</p>
<!-- @Frison:1992te assume a degree of correlation in measurements of outcome variables for a given unit (e.g., patient) that is independent of the time between observations.  -->
<p><span class="citation" data-cites="Frison:1992te">Frison and Pocock (<a href="#ref-Frison:1992te" role="doc-biblioref">1992</a>)</span> は、観測間の時間に依存しない、ある単位（たとえば、患者）の結果変数の測定値における相関の程度を仮定している。 <!-- A more plausible model in many business settings would be correlation in outcome measures for a given unit (e.g., firm) that fades as observations become further apart in time.  --> 多くのビジネス設定では、ある単位（たとえば、企業）の結果変数の測定値における相関が、観測間の時間が経つにつれて薄れるというモデルがより妥当である。 <!-- Along these lines, we create `get_outcomes()` below to generate data for outcomes in the absence of treatment.  --> このような考え方に沿って、以下の<code>get_outcomes()</code>を作成して、処置がない場合の結果のデータを生成する。 <!-- Specifically, we assume that, if there are no treatment or period effects, the outcome in question follows the autoregressive process embedded in `get_outcomes()`, which has the key parameter $\rho$ (`rho`).[^9] --> 具体的には、処置効果や期間効果がない場合、対象の結果は、<code>get_outcomes()</code>に埋め込まれた自己回帰過程に従うと仮定する。この過程には、主要なパラメータ <span class="math inline">\rho</span> (<code>rho</code>) が含まれている。<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_outcomes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">rho</span> <span class="op">=</span> <span class="fl">0</span>, </span>
<span>  <span class="va">periods</span> <span class="op">=</span> <span class="fl">7</span></span>
<span>  <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">periods</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">periods</span><span class="op">)</span></span>
<span>  <span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">e</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">periods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">e</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">periods</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The `get_sample()` function below uses `get_outcomes()` for `n` firms for given values of `rho`, `periods` (the number of periods observed for each firm), and `effect` (the underlying size of the effect of treatment on `y`).  -->
<p>次の<code>get_sample()</code>関数は、<code>rho</code>、<code>periods</code>（各企業について観測される期間の数）、および<code>effect</code>（<code>y</code>に対する処置の効果の基礎となるサイズ）の与えられた値に対して、<code>n</code>企業のために<code>get_outcomes()</code>を使用する。 <!-- Here treatment is randomly assigned to half the firms in the sample and the effect is added to `y` when both `treat` and `post` are true.  --> ここでは、処置はサンプルの半分の企業にランダムに割り当てられ、<code>treat</code>と<code>post</code>の両方が真の場合に<code>y</code>に効果が追加される。 <!-- We also add a time-specific effect (`t_effect`) for each period, which is common to all observations (a common justification for the use of DiD is the existence of such period effects).  --> また、各期間に対して時間特有の効果（<code>t_effect</code>）を追加し、すべての観測に共通である（DiDの使用の一般的な正当化の理由の1つは、このような期間効果が存在することである）。</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">rho</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">periods</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">effect</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">t_effects</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">periods</span>, t_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">periods</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">tibble</span><span class="op">(</span>id <span class="op">=</span> <span class="va">x</span>, <span class="fu">get_outcomes</span><span class="op">(</span>rho <span class="op">=</span> <span class="va">rho</span>, </span>
<span>                                               periods <span class="op">=</span> <span class="va">periods</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">map</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">f</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">t_effects</span>, by <span class="op">=</span> <span class="st">"t"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>treat <span class="op">=</span> <span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">treat</span>,</span>
<span>           post <span class="op">=</span> <span class="va">t</span> <span class="op">&gt;</span> <span class="va">periods</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>           y <span class="op">=</span> <span class="va">y</span> <span class="op">+</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">treat</span> <span class="op">&amp;</span> <span class="va">post</span>, <span class="va">effect</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">t_effect</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">t_effect</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The `est_effect()` function below applies a number of estimators to a given data set and returns the estimated treatment effect for each estimator.  -->
<p>以下の<code>est_effect()</code>関数は、与えられたデータセットにいくつかの推定量を適用し、各推定量の推定処置効果を返す。 <!-- The estimators we consider are the following (the labels *POST*, *CHANGE*, and *ANCOVA* come from [Frison and Pocock, 1992](references.html#ref-Frison:1992te)): --> 考慮する推定量は以下の通りである（ラベル<em>POST</em>、<em>CHANGE</em>、<em>ANCOVA</em>は<a href="references.html#ref-Frison:1992te">Frison and Pocock, 1992</a>から来ている）。</p>
<!-- - *DiD*, the difference-in-differences estimator estimated by regressing `y` on the treatment indicator, `treat` interacted with the post-treatment indicator, `post` (with the `[lm()](https://rdrr.io/r/stats/lm.html)` function automatically including the main effects of `treat` and `post`), as in [Equation 19.1](#eq-did). -->
<ul>
<li>
<em>DiD</em>は、処置指標<code>treat</code>と処置後指標<code>post</code>を交互作用させたものを回帰することによって推定される差分の差推定量であり、<code>treat</code>と<code>post</code>の主効果を自動的に含む<code>[lm()](https://rdrr.io/r/stats/lm.html)</code>関数によって推定される。<a href="#eq-did">Equation&nbsp;19.1</a>のようなものである。 <!-- - *POST*, which is based on OLS regression of `y` on `treat`, but with the sample restricted to the post-treatment observations, as in [Equation 19.2](#eq-post). -->
</li>
<li>
<em>POST</em>は、<code>y</code>を<code>treat</code>に対してOLS回帰するが、サンプルを処置後の観測に制限したものであり、<a href="#eq-post">Equation&nbsp;19.2</a>のようなものである。 <!-- - *CHANGE*, which is based on OLS regression of the change in the outcome on `treat`. The change in outcome (`y_change`) is calculated as the mean of post-treatment outcome value (`y_post`) minus the mean of the pre-treatment outcome value (`y_pre`) for each unit. -->
</li>
<li>
<em>CHANGE</em>は、アウトカムの変化を<code>treat</code>に対してOLS回帰するものである。アウトカムの変化（<code>y_change</code>）は、各単位について処置後のアウトカム値（<code>y_post</code>）の平均から処置前のアウトカム値（<code>y_pre</code>）の平均を引いたものである。 <!-- - *ANCOVA*, which is a regression of `y_post` on `treat` and `y_pre`, as in [Equation 19.3](#eq-ancova). -->
</li>
<li>
<em>ANCOVA</em>は、<code>y_post</code>を<code>treat</code>と<code>y_pre</code>に対して回帰するものであり、<a href="#eq-ancova">Equation&nbsp;19.3</a>のようなものである。</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">est_effect</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">fm_DiD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">post</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_POST</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">post</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">treat</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">fm_POST</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">df_POST</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df_CHANGE</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">treat</span>, <span class="va">post</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"post"</span>, values_from <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span>y_pre <span class="op">=</span> <span class="va">`FALSE`</span>,</span>
<span>           y_post <span class="op">=</span> <span class="va">`TRUE`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>y_change <span class="op">=</span> <span class="va">y_post</span> <span class="op">-</span> <span class="va">y_pre</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">fm_CHANGE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">y_post</span> <span class="op">-</span> <span class="va">y_pre</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">df_CHANGE</span><span class="op">)</span></span>
<span>  <span class="va">fm_ANCOVA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_post</span> <span class="op">~</span> <span class="va">y_pre</span> <span class="op">+</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">df_CHANGE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">tibble</span><span class="op">(</span>est_DiD <span class="op">=</span> <span class="va">fm_DiD</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="st">"treatTRUE:postTRUE"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         est_POST <span class="op">=</span> <span class="va">fm_POST</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="st">"treatTRUE"</span><span class="op">]</span><span class="op">]</span>, </span>
<span>         est_CHANGE <span class="op">=</span> <span class="va">fm_CHANGE</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="st">"treatTRUE"</span><span class="op">]</span><span class="op">]</span>, </span>
<span>         est_ANCOVA <span class="op">=</span> <span class="va">fm_ANCOVA</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[[</span><span class="st">"treatTRUE"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The `run_sim()` function below calls `get_sample()` for supplied parameter values to create a data set, and returns a data frame containing the results of applying `est_effect()` to that data set.  -->
<p>この<code>run_sim()</code>関数は、与えられたパラメータ値に対して<code>get_sample()</code>を呼び出してデータセットを作成し、そのデータセットに<code>est_effect()</code>を適用した結果を含むデータフレームを返す。</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">run_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">rho</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">periods</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">effect</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">get_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, rho <span class="op">=</span> <span class="va">rho</span>, periods <span class="op">=</span> <span class="va">periods</span>, effect <span class="op">=</span> <span class="va">effect</span><span class="op">)</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span>i <span class="op">=</span> <span class="va">i</span>, <span class="fu">est_effect</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- To facilitate running of the simulation for various values of `effect` and `rho`, we create a data frame (`params`) with effect sizes running from 0 to 1 and $\rho \in \{ 0, 0.18, 0.36, 0.54, 0.72, 0.9 \}$ . -->
<p><code>effect</code>と<code>rho</code>のさまざまな値に対してシミュレーションを実行するために、<code>effect</code>が0から1まで、<span class="math inline">\rho \in \{ 0, 0.18, 0.36, 0.54, 0.72, 0.9 \}</span> であるデータフレーム（<code>params</code>）を作成する。</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">0.9</span>, length.out <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> </span>
<span><span class="va">effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span>effect <span class="op">=</span> <span class="va">effects</span>, rho <span class="op">=</span> <span class="va">rhos</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The `run_sim_n()` function below runs 1000 simulations for the supplied values of `effect` and `rho` and returns a data frame with the results. -->
<p>以下の<code>run_sim_n()</code>関数は、与えられた<code>effect</code>と<code>rho</code>の値に対して1000回のシミュレーションを実行し、結果を含むデータフレームを返す。</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">run_sim_n</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">effect</span>, <span class="va">rho</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_sims</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">map</span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">run_sim</span><span class="op">(</span><span class="va">x</span>, rho <span class="op">=</span> <span class="va">rho</span>, effect <span class="op">=</span> <span class="va">effect</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">tibble</span><span class="op">(</span><span class="va">effect</span>, <span class="va">rho</span>, <span class="va">res</span><span class="op">)</span></span>
<span>                                    </span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<!-- The following code takes several minutes to run. Using `future_pmap` from the `furrr` package in place of `pmap()` reduces the time needed to run the simulation significantly. -->
<p>次のコードは実行に数分かかる。<code>pmap()</code>の代わりに<code>furrr</code>パッケージの<code>future_pmap</code>を使用すると、シミュレーションを実行するために必要な時間が大幅に短縮される。 <!-- Fortunately, nothing in the subsequent exercises requires that you run either variant of this code, so only do so if you have time and want to examine `results` directly. --> 幸いなことに、後続の演習では、このコードのいずれかを実行する必要はない。したがって、時間がある場合や<code>results</code>を直接調べたい場合にのみ実行すること。</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">params</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">future_pmap</span><span class="op">(</span><span class="va">run_sim_n</span>, </span>
<span>              .options <span class="op">=</span> <span class="fu">furrr_options</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">system_time</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- With `results` in hand, we can do some analysis.  -->
<p><code>results</code>が手に入ったので、いくつかの分析を行うことができる。 <!-- The first thing to note is that `est_CHANGE` is equivalent to `est_DiD`, as all estimates are within rounding error of each other for these two methods. --> 最初に注意すべきことは、<code>est_CHANGE</code>が<code>est_DiD</code>と同等であることである。これら2つの方法について、すべての推定値がお互いに丸め誤差の範囲内にあるためである。</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">results</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">est_DiD</span> <span class="op">-</span> <span class="va">est_CHANGE</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.00001</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Thus we just use the label *DiD* in subsequent analysis. -->
<p>したがって、以降の分析では、<em>DiD</em>というラベルを使用する。</p>
<!-- The second thing we check is that the methods provide unbiased estimates of the causal effect.  -->
<p>2つ目に確認することは、各方法が因果効果のバイアスのない推定値を提供するかどうかである。 <!-- [Figure 19.1](#fig-bias) suggests that the estimates are very close to the true values of causal effects for all three methods. --> <a href="#fig-bias">Figure&nbsp;19.1</a>は、すべての3つの方法について、推定値が因果効果の真の値に非常に近いことを示している。</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">results</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"est"</span><span class="op">)</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">"method"</span>, values_to <span class="op">=</span> <span class="st">"est"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>method <span class="op">=</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">method</span>, <span class="st">"^est.(.*)$"</span>, <span class="st">"\\1"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">rho</span>, <span class="va">method</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">est</span> <span class="op">-</span> <span class="va">effect</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">method</span> <span class="op">!=</span> <span class="st">"CHANGE"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">rho</span>, y <span class="op">=</span> <span class="va">bias</span>, </span>
<span>             colour <span class="op">=</span> <span class="va">method</span>, linetype <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylim</span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Having confirmed that there is no apparent bias in any of the estimators in this setting, we next consider the empirical standard errors for each method.  -->
<p>この設定において、どの推定量にも明らかなバイアスがないことを確認した後、次に各方法の実証的標準誤差を考慮する。 <!-- Because we get essentially identical plots with each value of the true effect, we focus on `effect == 0.5` in the following analysis.  --> 真の効果の各値で本質的に同一のプロットを得るため、以下の分析では<code>effect == 0.5</code>に焦点を当てる。 <!-- Here we rearrange the data so that we have a `method` column and an `est` column for the estimated causal effect.  --> ここでは、推定された因果効果の<code>method</code>列と<code>est</code>列を持つデータを再配置する。 <!-- We then calculate, for each `method` and value of `rho`, the standard deviation of `est`, which is the empirical standard error we seek.  --> 次に、各<code>method</code>と<code>rho</code>の値について、<code>est</code>の標準偏差を計算し、求めている実証的標準誤差を得る。 <!-- Finally, we plot the values for each value of `rho` in [Figure 19.2](#fig-ses). --> 最後に、<a href="#fig-ses">Figure&nbsp;19.2</a>に各<code>rho</code>の値をプロットする。</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">results</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    <span class="fu">starts_with</span><span class="op">(</span><span class="st">"est"</span><span class="op">)</span>, <span class="co"># estで始まる列を対象</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"method"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"est"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">method</span>, <span class="st">"^est.(.*)$"</span>, <span class="st">"\\1"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">method</span> <span class="op">!=</span> <span class="st">"CHANGE"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># CHANGEは除外</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">method</span>, <span class="va">rho</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># methodとrhoでグループ化</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span> <span class="co"># estの標準偏差を計算</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">rho</span>, y <span class="op">=</span> <span class="va">se</span>, colour <span class="op">=</span> <span class="va">method</span>, linetype <span class="op">=</span> <span class="va">method</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the above, we can see that for low values of <span class="math inline">\rho</span> , subtracting pre-treatment outcome values adds noise to our estimation of treatment effects. We actually have lower standard errors when we throw away the pre-treatment data and just compare post-treatment outcomes. But for higher levels of <span class="math inline">\rho</span> , we see that <em>DiD</em> outperforms <em>POST</em>; by subtracting pre-treatment outcome values, we get a more precise estimate of the treatment effect. However, we see that both <em>DiD</em> and <em>POST</em> are generally outperformed by <em>ANCOVA</em>, which in effect allows for a flexible, data-driven relation between pre- and post-treatment outcome values.</p>
<p>In short, notwithstanding its popularity, it is far from clear that DiD is the best approach to use for all analyses of causal effects based on experimental data. Even in the context of the Reg SHO experiment, the appropriate method may depend on the outcome of interest. For a persistent outcome, <em>DiD</em> may be better than <em>POST</em>, but for a less persistent outcome, <em>POST</em> may be better than <em>DiD</em>. And <em>ANCOVA</em> may be a better choice than either <em>POST</em> or <em>DiD</em> unless there are strong <em>a priori</em> reasons to believe that <em>DiD</em> or <em>POST</em> is more appropriate (and such reasons seem more likely to hold for <em>POST</em> than for <em>DiD</em>).</p>
</section><section id="valuating-natural-experiments" class="level2" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="valuating-natural-experiments">
<span class="header-section-number">11.4</span> valuating natural experiments</h2>
<p>Because of the plausibly random assignment mechanism used by the SEC, Reg SHO provides a very credible natural experiment. However, in many claimed natural experiments, it will be “nature” who is assigning treatment. In Michels (<a href="@Michels:2017uc">2017</a>), it was literally nature doing the assignment through the timing of natural disasters. While natural disasters are clearly not completely random, as hurricanes are more likely to strike certain locations at certain times of year, this is not essential for the natural experiment to provide a setting from which causal inferences can be credibly drawn. What is necessary in Michels (<a href="@Michels:2017uc">2017</a>) is that treatment assignment is <strong>as-if random</strong> with regard to the timing of the natural disaster before or after the end of the fiscal period and discussion questions in <a href="natural.html">Chapter 17</a> explored these issues.</p>
<p>More often in claimed natural experiments, it will be economic actors or forces, rather than nature, assigning treatment. While such economic actors and forces are unlikely to act at random, again the critical question is whether treatment assignment is <em>as-if</em> random. To better understand the issues, we consider a well-studied setting, that of brokerage closures as studied in <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span></p>
<p><span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012, 1368</a>)</span> argue that “brokerage closures are a plausibly exogenous source of variation in the extent of analyst coverage, as long as two conditions are satisfied. First, the resulting coverage terminations must correlate with an increase in information asymmetry. … Second, the terminations must only affect price and demand through their effect on information asymmetry.” Interestingly, these are essentially questions 2 and 3 that we ask in evaluating instrumental variables in <a href="iv.html#sec-iv-reasoning">Section 20.3</a>. The analogue with instrumental variables applies because <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> are primarily interested in the effects of changes in information asymmetry, not the effects of brokerage closures <em>per se</em>. In principle, brokerage closures could function much like an instrumental variable, except that <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> estimate <strong>reduced-form</strong> regressions whereby outcomes are related directly to brokerage closures, such as in Table 3 <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012, 1391</a>)</span>. But the first of the three questions from <a href="iv.html#sec-iv-reasoning">Section 20.3</a> remains relevant, and this is the critical question for evaluating any natural experiment: <strong>Is treatment assignment (as-if) random?</strong></p>
<p>Like many researchers, <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> do not address the (as-if) randomness of treatment assignment directly. Instead, <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> focus on whether brokerage closure-related terminations of analyst coverage “constitute a suitably exogenous shock to the investment environment”. <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> argue that they do “<em>unless</em> brokerage firms quit research because their analysts possessed negative private information about the stocks they covered.” But this reasoning is incomplete. For sure, brokerage firms not quitting research for the reason suggested is a <em>necessary</em> condition for a natural experiment (otherwise the issues with using brokerage closures as a natural experiment are quite apparent). But it is not a <em>sufficient</em> condition. If the firms encountering brokerage closure-related terminations of analyst coverage had different trends in information asymmetry for other reasons, the lack of private information is inadequate to give us a natural experiment.</p>
<p>In general, we should be able to evaluate the randomness of treatment assignment much as we would do so with an explicitly randomized experiment. Burt (<a href="references.html#ref-Burt:2000tm">2000</a>) suggest that “statisticians will compare the homogeneity of the treatment group populations to assess the distribution of the pretreatment demographic characteristics and confounding factors.” With explicit randomization, statistically significant differences in pretreatment variables might prompt checks to ensure that, say, there was not “deliberate alteration of or noncompliance with the random assignment code” or any other anomalies. Otherwise, we might have greater confidence that randomization was implemented effectively, and hence that causal inferences might reliably be drawn from the study.</p>
<p>So, a sensible check with a natural experiment would seem to be to compare various pre-treatment variables across treatment groups to gain confidence that “nature” has indeed randomized treatment assignment. In this regard, Table 1 of <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> is less than assuring. Arguably, one can only encounter brokerage closure-related terminations of analyst coverage if one has analyst coverage in the first place; so the relevant comparison is arguably between the first and third columns of data. There we see that the typical firm in the terminations sample (column 1) is larger, has higher monthly stock turnover, higher daily return volatility, and more brokers covering the stock than does the typical firm in the universe of covered stocks in 2004 (column 3). So clearly “nature” has not randomly selected firms from the universe of covered stocks in 2004.</p>
<p>However, we might come to a similar conclusion if we compared the Reg SHO pilot stocks with the universe of traded stocks or some other broad group. Just as it was essential to correctly identify the population that the SEC considered in randomizing treatment assignment, it is important to identify the population that “nature” considered in assigning treatment in evaluating any natural experiment. While the SEC provided a statement detailing how it constructed the sample, “nature” is not going to do the same and researchers need to consider carefully which units were considered for (as if) random assignment to treatment.</p>
<p>In this regard, even assuming that the controls used in Table 2 of@Kelly:2012ul [p.1388] were the ones “nature” herself considered, it seems that the natural experiment did not assign treatment in a sufficiently random way. Table 2 studies four outcomes: bid-ask spreads, the Amihud illiquidity measure, missing- and zero-return days, and measures related to earnings announcements. In each case, there are pre-treatment differences that sometimes exceed the DiD estimates. For example, pre-treatment bid-ask spreads for treatment and control firms are 1.126 and 1.089, a 0.037 difference that is presumably statistically significant given that the smaller DiD estimate of 0.020 has a p-value of 0.011.<a href="#fn10">10</a> In light of this evidence, it seems that <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> need to rely on the parallel trends assumption to draw causal inferences and we evaluate the plausibility of this assumption in the next section.</p>
<p>It is important to recognize that the shortcomings of broker closures as a natural experiment do not completely undermine the ability of <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> to draw causal inferences. There appears to be an unfortunate tendency to believe, on the one hand, that without some kind of natural experiment, one cannot draw causal inferences. On the other hand, there is an apparent tendency to view natural experiments as giving <em>carte blanche</em> to researchers to draw all kinds of causal inferences, even when the alleged identification strategies do not, properly understood, support such inferences.</p>
<p>In the case of <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span>, it seems the authors would like to believe that they have a natural experiment that allows them to draw inferences about the effects of broker closures on information asymmetry (Table 2) and, because broker closures only affect stock prices through their effects on information asymmetry, to conclude from the evidence in Table 3 that increases in information asymmetry reduce stock prices. But Table 2 could have been based on a bullet-proof identification strategy without implying that broker closures only affect stock prices through their effects on information asymmetry. There is really no evidence offered for this claim, one that is arguably very difficult to support.</p>
<p>At the same time, it is conceptually possible that <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> could provide compelling evidence that the only plausible explanation for the abnormal returns in Table 3 is reductions in information asymmetry, even if the results in Table 2 were irredeemably corrupted (e.g., because of failure of parallel trends). Evidence that firms did not “quit research because their analysts possessed negative private information about the stocks they covered” might support drawing certain inferences from Table 3 even without a credible equivalent of Table 2.</p>
</section><section id="the-parallel-trends-assumption" class="level2" data-number="11.5"><h2 data-number="11.5" class="anchored" data-anchor-id="the-parallel-trends-assumption">
<span class="header-section-number">11.5</span> The parallel trends assumption</h2>
<p>Examining the studies of the direct effects of Reg SHO discussed in <a href="#sec-sho-early">Section 19.2.3</a>, we see that randomization generally provided balance in pre-treatment outcome values. In such settings, we see that DiD can provide unbiased estimates of causal effects, but that it has little appeal when treatment assignment is random. Indeed, if there is little to distinguish treatment and control observations in terms of pre-treatment outcome values, DiD will differ little from simply comparing differences in post-treatment means (the <em>POST</em> estimator discussed above).</p>
<p>But in many settings, such as that in <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span>, differences in pre-treatment outcome values exist, suggesting that random assignment is not an appropriate assumption. In such settings, it will therefore be necessary to rely on a different assumption to justify the use of DiD for causal inferences. This <strong>parallel trends assumption</strong> posits that, but for treatment, the expected change in the outcome variable for the treated observations would equal that for control observations. Using this assumption, we can attribute any difference in the change in the outcome variable between the treated and control observations to a treatment effect and random variation and use standard tools of statistical inference to evaluate the null hypothesis that any difference is due to random variation.</p>
<p>That DiD can be predicated on an assumption other than (as-if) random assignment may explain its popularity. Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021, p.&nbsp;406</a>) suggests that DiD “has become the single most popular research design in the quantitative social sciences” and <span class="citation" data-cites="Armstrong:2021uo">Armstrong et al. (<a href="#ref-Armstrong:2021uo" role="doc-biblioref">2022, 4</a>)</span> find rapid “increase in [the number of] papers using quasi-experimental methods to draw causal inferences, that more than 75% of such papers use variations of the classic difference-in-differences design.”</p>
<p>Arguably DiD is more often used in settings that <em>without</em> (as-if) random assignment of treatment. For example, one of the most highly cited papers using DiD is <span class="citation" data-cites="Card:1994aa">Card and Krueger (<a href="#ref-Card:1994aa" role="doc-biblioref">2000</a>)</span>, which compares the change in employment in the fast-food industry in New Jersey and Philadelphia before and after an increase in the minimum wage in New Jersey. In this case, treatment assignment was very clearly non-random—it was a function of being located in New Jersey.</p>
<p>Unlike the assumption of random assignment, the parallel trends assumption is not implied by a reasonable description of a physical or economic process and thus is of a fundamentally different nature. Random assignment is widely regarded as a reasonable description of, say, a coin toss or the generation of pseudo-random numbers using a computer. In contrast, it is difficult to think of a mechanism for imposing parallel trends on the data. Because DiD is—unlike instrumental variables or regression discontinuity designs—generally <em>not</em> predicated on “as-if random variation in the explanatory variable of interest”, it is not correct to consider DiD as a <strong>quasi-experimental method</strong> (<a href="references.html#ref-Armstrong:2021uo">Armstrong et al., 2022, p.&nbsp;3</a>).<a href="#fn11">11</a></p>
<p>Instead the basis for the parallel trends assumption appears to be that it is <em>the</em> assumption that is necessary (and sufficient) for the DiD estimator to provide an unbiased estimator of the causal effect of treatment. But <a href="https://en.wikipedia.org/wiki/Assume_a_can_opener">“assuming a can-opener”</a> seems to be a weak foundation for an approach as widespread as DiD.</p>
<p>On the one hand, as discussed above, there is no obvious economic basis for the parallel trends assumption with general applicability. On the other hand, there are often reasons to believe that the parallel trends assumption will <em>not</em> hold for various outcomes. The parallel trends assumption will be dubious when the outcome variable tends to be mean-reverting. For example, it is well known that accounting-based measures of operating performance tend to revert towards the mean. So if treatment and control observations have different levels of pre-treatment operating performance, the parallel trends assumption will be a highly dubious basis for causal inference.</p>
<p>Another reason to doubt the parallel trends assumption is the fact that the measurement of outcomes is often arbitrary. For example, Li et al.&nbsp;(<a href="references.html#ref-Li:2018tj">2018</a>) examine the effect of legal changes on disclosure of customer identities using a variant of DiD.<a href="#fn12">12</a> One primary outcome measure considered by Li et al.&nbsp;(<a href="references.html#ref-Li:2018tj">2018</a>) is <span class="math inline">ratio</span> , the proportion of significant customers whose identities are not disclosed. But if the parallel trends assumption holds in <span class="math inline">ratio</span> then, so long as there are pre-treatment differences between treatment and control observations, it is not mathematically possible for parallel trends to hold in <span class="math inline">\log(1 + ratio)</span> , which is the measure used in the regression analysis in Li et al.&nbsp;(<a href="references.html#ref-Li:2018tj">2018</a>).</p>
<p>The apparent flimsiness of the parallel trends assumption underlying DiD analysis in non-randomized settings is perhaps reinforced by the treatment of DiD in textbooks. Imbens and Rubin (<a href="references.html#ref-Imbens:2015aa">2015</a>), a significant recent tome on causal inference, buries DiD in endnotes, merely noting that DiD is “widely used” (<a href="references.html#ref-Imbens:2015aa">2015, p.&nbsp;44</a>) before directing the reader to Angrist and Pischke (<a href="references.html#ref-Angrist:2008vk">2008</a>). While Angrist and Pischke (<a href="references.html#ref-Angrist:2008vk">2008</a>) discuss DiD and its assumptions, and relate it to fixed-effects regressions and panel data methods, they do little to justify the parallel trends assumption. Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021</a>) is much more cautious in discussing the parallel trends assumption, which he notes “is by definition untestable since we cannot observe this counterfactual conditional expectation [of post-treatment outcomes absent treatment]”.</p>
<p>Two popular approaches to address the parallel trends assumption are discussed by Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021</a>) and Huntington-Klein (<a href="references.html#ref-Huntington-Klein:2021uc">2021</a>). The first approach compares the trends in pre-treatment outcome values for treatment and control observations. If these trends are similar before treatment, it is perhaps reasonable to assume they are similar after treatment. But Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021, p.&nbsp;426</a>) notes that “pre-treatment similarities are neither necessary nor sufficient to guarantee parallel counterfactual trends” and this seems an especially dubious assumption if treatment is endogenously selected.</p>
<p>The second approach is the placebo test, variants of which are discussed by Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021</a>) and Huntington-Klein (<a href="references.html#ref-Huntington-Klein:2021uc">2021</a>). One placebo test involves evaluating the treatment effect in a setting where prior beliefs hold that there should be no effect. Another approach involves a kind of random assignment of a pseudo-treatment. In either case, not finding an effect is considered as providing support for the parallel trends assumption in the analysis of greater interest to the researcher. Of course, one might be sceptical of such placebo tests in light of the concerns raised at the start of this chapter. If applying DiD to state-level data on spending on science, space, and technology provides evidence of an effect on suicides by hanging, strangulation, and suffocation, not finding an effect on deaths by drowning after falling out of a canoe or kayak may provide limited assurance.</p>
<p>To illustrate, we now apply a kind of placebo test to evaluate the parallel trends assumption for bid-ask spreads, one of the variables considered in the DiD analysis of Table 2 of <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span> (we choose spreads in part because it is easy to calculate).</p>
<p>We first create the data set <code>spreads</code>, which contains data on the average spread for stocks over three-month periods—aligning with one measure used Table 2 of <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span>—for a sample period running from Q1, 2001 (the first quarter of 2001) to Q1, 2008, which is the sample period in <span class="citation" data-cites="Kelly:2012ul">Kelly and Ljungqvist (<a href="#ref-Kelly:2012ul" role="doc-biblioref">2012</a>)</span>. We will conduct a study of a pseudo-treatment that we will assume applies for periods beginning in Q1, 2004, which is roughly halfway through the sample period and we code <code>post</code> accordingly.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">PostgreSQL</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">parquet</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html">Postgres</a></span><span class="op">(</span><span class="op">)</span>, bigint <span class="op">=</span> <span class="st">"integer"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dsf</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"dsf"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spreads</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">dsf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>spread <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">ask</span> <span class="op">-</span> <span class="va">bid</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="op">(</span><span class="va">ask</span> <span class="op">+</span> <span class="va">bid</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>         quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="va">date</span>, <span class="st">'quarter'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">permno</span>, <span class="va">quarter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>spread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">spread</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>post <span class="op">=</span> <span class="va">quarter</span> <span class="op">&gt;=</span> <span class="st">"2004-01-01"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">spread</span><span class="op">)</span>, </span>
<span>         <span class="fu">between</span><span class="op">(</span><span class="va">quarter</span>, <span class="st">"2000-01-01"</span>, <span class="st">"2008-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dsf</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"crsp"</span>, table <span class="op">=</span> <span class="st">"dsf"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spreads</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">dsf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>spread <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">ask</span> <span class="op">-</span> <span class="va">bid</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="op">(</span><span class="va">ask</span> <span class="op">+</span> <span class="va">bid</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>         quarter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="va">date</span>, <span class="st">'quarter'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">permno</span>, <span class="va">quarter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>spread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">spread</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>post <span class="op">=</span> <span class="va">quarter</span> <span class="op">&gt;=</span> <span class="st">"2004-01-01"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">spread</span><span class="op">)</span>, </span>
<span>         <span class="fu">between</span><span class="op">(</span><span class="va">quarter</span>, <span class="st">"2000-01-01"</span>, <span class="st">"2008-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>We now randomize treatment assignment. Because we want to evaluate the parallel trends assumption and completely randomized treatment assignment <em>implies</em> a trivial version of the parallel trends assumption, we specify a small difference in the probability of receiving treatment for observations whose pre-treatment spread exceeds the median ((p = 0.55)) from those whose pre-treatment spread is below the median ((p = 0.45)). This ensures that we have pre-treatment differences and thus need to rely on the parallel trends assumption in a meaningful way.<a href="#fn13">13</a></p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span></span>
<span></span>
<span><span class="va">treatment</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">spreads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">post</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">permno</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>spread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">spread</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>treat_prob <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">spread</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">spread</span><span class="op">)</span>, <span class="fl">0.55</span>, <span class="fl">0.45</span><span class="op">)</span>,</span>
<span>         rand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="fu">pick</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         treat <span class="op">=</span> <span class="va">rand</span> <span class="op">&lt;</span> <span class="va">treat_prob</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">permno</span>, <span class="va">treat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Obviously the null hypothesis of zero treatment effect holds with this “treatment”, but the question is whether the parallel trends assumption holds for <code>spread</code>. If we find evidence of a “treatment effect”, the only sensible interpretation is a failure of the parallel trends assumption for <code>spread</code>.</p>
<p>Merging in the <code>treatment</code> data set, we estimate a DiD regression (and cluster standard errors by <code>permno</code> for reasons that will be apparent after reading the discussion below). Results are reported in <a href="#tbl-placebo">Table&nbsp;19.2</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">reg_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">spreads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">treatment</span>, by <span class="op">=</span> <span class="st">"permno"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">fm</span> <span class="op">&lt;-</span> <span class="fu">feols</span><span class="op">(</span><span class="va">spread</span> <span class="op">~</span> <span class="va">post</span> <span class="op">*</span> <span class="va">treat</span>, vcov <span class="op">=</span> <span class="op">~</span> <span class="va">permno</span>, data <span class="op">=</span> <span class="va">reg_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">modelsummary</span><span class="op">(</span><span class="va">fm</span>,</span>
<span>             estimate <span class="op">=</span> <span class="st">"{estimate}{stars}"</span>,</span>
<span>             gof_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nobs"</span><span class="op">)</span>,</span>
<span>             stars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'*'</span> <span class="op">=</span> <span class="fl">.1</span>, <span class="st">'**'</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="st">'***'</span> <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because we find a statistically significant effect of <span class="math inline">-0.343</span> with a t-statistic of <span class="math inline">-4.96</span> with this meaningless “treatment”, we can conclude with some confidence that the parallel trends assumption simply does not hold for <code>spread</code> in this sample. Given that we might have passed this placebo test even if the parallel trends assumption did not hold for a particular treatment, say due to endogenous selection, it seems reasonable to view this test as being better suited to detecting a failure of parallel trends (as it does here) than it is to validation of that assumption.</p>
<p>Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021</a>) and Huntington-Klein (<a href="references.html#ref-Huntington-Klein:2021uc">2021</a>) provide excellent pathways to a recent literature examining DiD. However, it is important to recognize that some variant of the scientifically flimsy parallel trends assumption imbues all of these treatments. It would seem to be productive for researchers to discard the “quasi-experimental” pretence attached to DiD and to apply techniques appropriate to what some call <strong>interrupted time-series designs</strong> (e.g., <a href="references.html#ref-Shadish:2002uv">Shadish et al., 2002</a>).<a href="#fn14">14</a></p>
<p>While a randomized experiment provides a sound basis for attributing observed differences in outcomes to either treatment effects or sampling variation, without such randomization, it is perhaps more appropriate to take a more <strong>abductive</strong> approach of identifying causal mechanisms, deeper predictions about the timing and nature of causal effects, explicit consideration of alternative explanations, and the like (<a href="references.html#ref-Armstrong:2021uo">Armstrong et al., 2022</a>; <a href="references.html#ref-Heckman:2017uj">Heckman and Singer, 2017</a>). Some evidence of this is seen in the discussion of specific papers in Cunningham (<a href="references.html#ref-Cunningham:2021vk">2021</a>), perhaps reflecting reluctance to lean too heavily on the parallel trends assumption.</p>
</section><section id="indirect-effects-of-reg-sho" class="level2" data-number="11.6"><h2 data-number="11.6" class="anchored" data-anchor-id="indirect-effects-of-reg-sho">
<span class="header-section-number">11.6</span> Indirect effects of Reg SHO</h2>
<p>The early studies of Reg SHO discussed above can be viewed as studying the more <em>direct</em> effects of Reg SHO. As a policy change directly affecting the ability of short-sellers to trade in securities, the outcomes studied by these earlier studies are more closely linked to the Reg SHO pilot than are the outcomes considered in later studies. Black et al.&nbsp;(<a href="references.html#ref-Black:2019vv">2019, pp.&nbsp;2–3</a>) point out that “despite little evidence of direct impact of the Reg SHO experiment on pilot firms, over 60 papers in accounting, finance, and economics report that suspension of the price tests had wide-ranging <em>indirect</em> effects on pilot firms, including on earnings management, investments, leverage, acquisitions, management compensation, workplace safety, and more.”</p>
<p>One indirect effect of short-selling that has been studied in subsequent research is that on earnings management. To explore this topic, we focus on Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016, p.&nbsp;1251</a>), who find “that short-selling, or its prospect, curbs earnings management.”</p>
<section id="earnings-management-after-dechow-et-al.-1995" class="level3" data-number="11.6.1"><h3 data-number="11.6.1" class="anchored" data-anchor-id="earnings-management-after-dechow-et-al.-1995">
<span class="header-section-number">11.6.1</span> Earnings management after Dechow et al.&nbsp;(<a href="references.html#ref-Dechow:1995wr">1995</a>)</h3>
<p>In <a href="earnings-mgt.html">Chapter 16</a>, we saw that early earnings management research used firm-specific regressions in estimating standard models such as the Jones (<a href="references.html#ref-Jones:1991vx">1991</a>) model. Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>) apply subsequent innovations in measurement of earnings management, such the <strong>performance-matched discretionary accruals</strong> measure developed in <span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> .</p>
<p><span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> replace the firm-specific regressions seen in Dechow et al.&nbsp;(<a href="references.html#ref-Dechow:1995wr">1995</a>) with regressions by industry-year, where industries are defined as firms grouped by two-digit SIC codes. <span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> also add an intercept term to the Jones Model and estimate discretionary accruals under the Modified Jones Model by applying the coefficients from the Jones Model to the analogous terms of the Modified Jones Model.<a href="#fn15">15</a></p>
<p>To calculate performance-matched discretionary accruals, Kothari et al.&nbsp;(<a href="references.html#ref-Kothari:2005aa">2005, p.&nbsp;1263</a>) “match each sample firm with the firm from the same fiscal year-industry that has the closest return on assets as the given firm. The performance-matched discretionary accruals … are then calculated as the firm-specific discretionary accruals minus the discretionary accruals of the matched firm.” This is the primary measure of earnings management used by Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>), but note that Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>) use the 48-industry Fama-French groupings, rather than the two-digit SIC codes used in <span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> .</p>
</section><section id="fhk-data-steps" class="level3" data-number="11.6.2"><h3 data-number="11.6.2" class="anchored" data-anchor-id="fhk-data-steps">
<span class="header-section-number">11.6.2</span> FHK: Data steps</h3>
<p>To construct measures of discretionary accruals, Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>) obtain data primarily from Compustat, along with data on Fama-French industries from Ken French’s website and data on the SHO pilot indicator from the SEC’s website. The following code is adapted from <a href="https://go.unimelb.edu.au/f7d8">code posted by the authors</a> of Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>), which was used to produce the results found in Tables 15 and 16 of Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019</a>). The bulk of the Compustat data used in Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>) come from <code>comp.funda</code>. Following Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019</a>), the code below collects data from that table for fiscal years between 1999 and 2012, excluding firms with SIC codes between 6000 and 6999 or between 4900 and 4949.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">PostgreSQL</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">parquet</a></li>
</ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html">Postgres</a></span><span class="op">(</span><span class="op">)</span>, bigint <span class="op">=</span> <span class="st">"integer"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">funda</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">db</span>, <span class="fu">Id</span><span class="op">(</span>schema <span class="op">=</span> <span class="st">"comp"</span>, table <span class="op">=</span> <span class="st">"funda"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compustat_annual</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">funda</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">indfmt</span> <span class="op">==</span> <span class="st">'INDL'</span>, <span class="va">datafmt</span> <span class="op">==</span> <span class="st">'STD'</span>, <span class="va">popsrc</span> <span class="op">==</span> <span class="st">'D'</span>, <span class="va">consol</span> <span class="op">==</span> <span class="st">'C'</span>, </span>
<span>         <span class="fu">between</span><span class="op">(</span><span class="va">fyear</span>, <span class="fl">1999</span>, <span class="fl">2012</span><span class="op">)</span>,</span>
<span>         <span class="op">!</span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">sich</span>, <span class="fl">6000</span>, <span class="fl">6999</span><span class="op">)</span> <span class="op">|</span> <span class="fu">between</span><span class="op">(</span><span class="va">sich</span>, <span class="fl">4900</span>, <span class="fl">4949</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">datadate</span>, <span class="va">fyr</span>, <span class="va">sich</span>, <span class="va">dltt</span>, <span class="va">dlc</span>, <span class="va">seq</span>,</span>
<span>         <span class="va">oibdp</span>, <span class="va">ib</span>, <span class="va">ibc</span>, <span class="va">oancf</span>, <span class="va">xidoc</span>, <span class="va">at</span>, <span class="va">ppegt</span>, <span class="va">sale</span>, </span>
<span>         <span class="va">rect</span>, <span class="va">ceq</span>, <span class="va">csho</span>, <span class="va">prcc_f</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fyear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">funda</span> <span class="op">&lt;-</span> <span class="fu">load_parquet</span><span class="op">(</span><span class="va">db</span>, schema <span class="op">=</span> <span class="st">"comp"</span>, table <span class="op">=</span> <span class="st">"funda"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compustat_annual</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">funda</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">indfmt</span> <span class="op">==</span> <span class="st">'INDL'</span>, <span class="va">datafmt</span> <span class="op">==</span> <span class="st">'STD'</span>, <span class="va">popsrc</span> <span class="op">==</span> <span class="st">'D'</span>, <span class="va">consol</span> <span class="op">==</span> <span class="st">'C'</span>, </span>
<span>         <span class="fu">between</span><span class="op">(</span><span class="va">fyear</span>, <span class="fl">1999</span>, <span class="fl">2012</span><span class="op">)</span>,</span>
<span>         <span class="op">!</span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">sich</span>, <span class="fl">6000</span>, <span class="fl">6999</span><span class="op">)</span> <span class="op">|</span> <span class="fu">between</span><span class="op">(</span><span class="va">sich</span>, <span class="fl">4900</span>, <span class="fl">4949</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">datadate</span>, <span class="va">fyr</span>, <span class="va">sich</span>, <span class="va">dltt</span>, <span class="va">dlc</span>, <span class="va">seq</span>,</span>
<span>         <span class="va">oibdp</span>, <span class="va">ib</span>, <span class="va">ibc</span>, <span class="va">oancf</span>, <span class="va">xidoc</span>, <span class="va">at</span>, <span class="va">ppegt</span>, <span class="va">sale</span>, </span>
<span>         <span class="va">rect</span>, <span class="va">ceq</span>, <span class="va">csho</span>, <span class="va">prcc_f</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fyear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Some regressions in Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019</a>) consider controls for market-to-book, leverage, and return on assets, which are calculated as <code>mtob</code>, <code>leverage</code>, and <code>roa</code>, respectively, in the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">controls_raw</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">compustat_annual</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>lag_fyear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span>,</span>
<span>         mtob <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">ceq</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">csho</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">prcc_f</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">ceq</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>         leverage <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">dltt</span> <span class="op">+</span> <span class="va">dlc</span> <span class="op">+</span> <span class="va">seq</span> <span class="op">!=</span> <span class="fl">0</span>, </span>
<span>                            <span class="op">(</span><span class="va">dltt</span> <span class="op">+</span> <span class="va">dlc</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">dltt</span> <span class="op">+</span> <span class="va">dlc</span> <span class="op">+</span> <span class="va">seq</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>         roa <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">oibdp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">fyear</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">datadate</span>, <span class="va">fyear</span>, <span class="va">at</span>, <span class="va">mtob</span>, <span class="va">leverage</span>, <span class="va">roa</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Following Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019</a>), we create <code>controls_filled</code>, which uses <code>[fill()](https://tidyr.tidyverse.org/reference/fill.html)</code> to remove many missing values for the controls.</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">controls_filled</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">controls_raw</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fill</span><span class="op">(</span><span class="va">at</span>, <span class="va">mtob</span>, <span class="va">leverage</span>, <span class="va">roa</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Following Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019</a>), we create <code>controls_fyear_avg</code>, which calculates averages of controls by fiscal year.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">controls_fyear_avg</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">controls_filled</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">at</span>, <span class="va">mtob</span>, <span class="va">leverage</span>, <span class="va">roa</span><span class="op">)</span>, </span>
<span>                   \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019</a>), we use values from <code>controls_fyear_avg</code> to replace missing values for controls.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_controls</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">controls_filled</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">controls_fyear_avg</span>, by <span class="op">=</span> <span class="st">"fyear"</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_avg"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>at <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">at</span>, <span class="va">at_avg</span><span class="op">)</span>,</span>
<span>         mtob <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">mtob</span>, <span class="va">mtob_avg</span><span class="op">)</span>,</span>
<span>         leverage <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">leverage</span>, <span class="va">leverage_avg</span><span class="op">)</span>,</span>
<span>         roa <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">roa</span>, <span class="va">roa_avg</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">at</span>, <span class="va">mtob</span>, <span class="va">leverage</span>, <span class="va">roa</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are multiple steps in the code above and the reasons for the steps involved in calculating <code>controls_filled</code> from <code>controls_raw</code> and <code>df_controls</code> from <code>controls_filled</code> are explored in the exercises below.</p>
<p>As discussed above, FHK estimate discretionary-accrual models by industry and year, where industries are based on the Fama-French 48-industry grouping. To create these industries here, we use <code>[get\_ff\_ind()](https://rdrr.io/pkg/farr/man/get_ff_ind.html)</code>, introduced in <a href="web-data.html">Chapter 9</a> and provided by the <code>farr</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ff_data</span> <span class="op">&lt;-</span> <span class="fu">get_ff_ind</span><span class="op">(</span><span class="fl">48</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now create functions to compile the data we need to estimate performance-matched discretionary accruals. We use a function to compile the data because (i) doing so is easy in R and (ii) it allows us to re-use code much easily, which will be important for completing the exercises in this chapter.</p>
<p>The first function we create is <code>get_das()</code>, which takes as its first argument (<code>compustat</code>) a data set derived from Compustat with the requisite data. The second argument (<code>drop_extreme</code>) allows to easily tweak the handling of outliers in a way examined in the exercises.</p>
<p>Within <code>get_das()</code>, the first data set we compile is <code>for_disc_accruals</code>, which contains the raw data for estimating discretionary-accruals models. Following FHK, we require each industry-year to have at least 10 observations for inclusion in our analysis and impose additional data requirements, some of which we explore in the exercises below.</p>
<p>Following FHK, we estimate discretionary-accrual models by industry and year and store the results in the data frame <code>fm_da</code>. We then merge the underlying data (<code>for_disc_accruals</code>) with <code>fm_da</code> to use the estimated models to calculate non-discretionary accruals (<code>nda</code>). Because the coefficient on <code>sale_c_at</code> is applied to <code>salerect_c_at</code>, we cannot use <code>[predict()](https://rdrr.io/r/stats/predict.html)</code> or <code>[residuals()](https://rdrr.io/r/stats/residuals.html)</code> in a straightforward fashion and need calculate <code>nda</code> “by hand”. We then calculate discretionary accruals (<code>da = acc_at - nda</code>) and return the data.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_das</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">compustat</span>, <span class="va">drop_extreme</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">for_disc_accruals</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">compustat</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">ff_data</span>, </span>
<span>               <span class="fu">join_by</span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">sich</span>, <span class="va">sic_min</span>, <span class="va">sic_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyr</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">arrange</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>lag_fyear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span>,</span>
<span>           acc_at <span class="op">=</span> <span class="op">(</span><span class="va">ibc</span> <span class="op">-</span> <span class="op">(</span><span class="va">oancf</span> <span class="op">-</span> <span class="va">xidoc</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span>,</span>
<span>           one_at <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span>,</span>
<span>           ppe_at <span class="op">=</span> <span class="va">ppegt</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span>,</span>
<span>           sale_c_at <span class="op">=</span> <span class="op">(</span><span class="va">sale</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">sale</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span>,</span>
<span>           salerect_c_at <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">sale</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">sale</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> </span>
<span>                              <span class="op">(</span><span class="va">rect</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">rect</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>keep <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">drop_extreme</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">acc_at</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1</span>,</span>
<span>                            .default <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">lag_fyear</span> <span class="op">==</span> <span class="va">fyear</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>           <span class="va">keep</span>, </span>
<span>           <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">salerect_c_at</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">acc_at</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ppe_at</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">ff_ind</span>, <span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>num_obs <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">num_obs</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fm_da</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">for_disc_accruals</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">ff_ind</span>, <span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">do</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">tidy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">acc_at</span> <span class="op">~</span> <span class="va">one_at</span> <span class="op">+</span> <span class="va">sale_c_at</span> <span class="op">+</span> <span class="va">ppe_at</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">unnest</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">ff_ind</span>, <span class="va">fyear</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"term"</span>, values_from <span class="op">=</span> <span class="st">"estimate"</span>, </span>
<span>                names_prefix <span class="op">=</span> <span class="st">"b_"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">for_disc_accruals</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">fm_da</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ff_ind"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>nda <span class="op">=</span> <span class="va">`b_(Intercept)`</span> <span class="op">+</span> <span class="va">one_at</span> <span class="op">*</span> <span class="va">b_one_at</span> <span class="op">+</span> <span class="va">ppe_at</span> <span class="op">*</span> <span class="va">b_ppe_at</span> <span class="op">+</span> </span>
<span>                   <span class="va">salerect_c_at</span> <span class="op">*</span> <span class="va">b_sale_c_at</span>,</span>
<span>           da <span class="op">=</span> <span class="va">acc_at</span> <span class="op">-</span> <span class="va">nda</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">ff_ind</span>, <span class="va">acc_at</span>, <span class="va">da</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step in the data preparation process is to match each firm with another based on performance. Following FHK, we calculate performance as lagged “Income Before Extraordinary Items” (<code>ib</code>) divided by lagged “Total Assets” (<code>at</code>) and <code>perf_diff</code>, the absolute difference between performance for each firm-year and each other firm-year in the same industry. We then select the firm (<code>gvkey_other</code>) with the smallest value of <code>perf_diff</code>. We rename the variable containing the discretionary accruals of the matching firm as <code>da_other</code> and calculate performance-matched discretionary accruals (<code>da_adj</code>) as the difference between discretionary accruals for the target firm (<code>da</code>) and discretionary accruals for the matched firm (<code>da_other</code>), and return the results. Note that <code>get_pm()</code> includes the argument <code>pm_lag</code> with default value <code>TRUE</code>. If <code>pm_lag</code> is set to <code>FALSE</code>, then performance for matching is calculated using contemporary values of <code>ib</code> and <code>at</code> (this option is examined in the exercises below).</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_pm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">compustat</span>, <span class="va">das</span>, <span class="va">pm_lag</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">drop_extreme</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">das</span> <span class="op">&lt;-</span> <span class="fu">get_das</span><span class="op">(</span><span class="va">compustat</span>, drop_extreme <span class="op">=</span> <span class="va">drop_extreme</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">perf</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">compustat</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">arrange</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ib_at <span class="op">=</span> </span>
<span>      <span class="fu">case_when</span><span class="op">(</span><span class="va">pm_lag</span> <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">ib</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>                .default <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">at</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">ib</span> <span class="op">/</span> <span class="va">at</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">das</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">ff_ind</span>, <span class="va">ib_at</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">perf_match</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">perf</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">perf</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fyear"</span>, <span class="st">"ff_ind"</span><span class="op">)</span>,</span>
<span>               suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_other"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">gvkey</span> <span class="op">!=</span> <span class="va">gvkey_other</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>perf_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">ib_at</span> <span class="op">-</span> <span class="va">ib_at_other</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">perf_diff</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">perf_diff</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">gvkey_other</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">perf_matched_accruals</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">das</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">rename</span><span class="op">(</span>gvkey_other <span class="op">=</span> <span class="va">gvkey</span>,</span>
<span>           da_other <span class="op">=</span> <span class="va">da</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">fyear</span>, <span class="va">gvkey_other</span>, <span class="va">da_other</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">perf_match</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fyear"</span>, <span class="st">"gvkey_other"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">gvkey_other</span>, <span class="va">da_other</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">das</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">perf_matched_accruals</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>da_adj <span class="op">=</span> <span class="va">da</span> <span class="op">-</span> <span class="va">da_other</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span>, <span class="va">acc_at</span>, <span class="va">da</span>, <span class="va">da_adj</span>, <span class="va">da_other</span>, <span class="va">gvkey_other</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The final step is performed in <code>get_pmdas()</code>. This function gets the needed data using <code>get_pm()</code>, then filters duplicate observations based on <code>(gvkey, fyear)</code> (the rationale for this step is explored in the discussion questions).</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_pmdas</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">compustat</span>, <span class="va">pm_lag</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">drop_extreme</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">get_pm</span><span class="op">(</span><span class="va">compustat</span>, </span>
<span>         pm_lag <span class="op">=</span> <span class="va">pm_lag</span>,</span>
<span>         drop_extreme <span class="op">=</span> <span class="va">drop_extreme</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we simply pass the data set <code>compustat_annual</code> to <code>get_pmdas()</code> and store the result in <code>pmdas</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pmdas</span> <span class="op">&lt;-</span> <span class="fu">get_pmdas</span><span class="op">(</span><span class="va">compustat_annual</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The remaining data set used by FHK is <code>sho_data</code>, which we discussed in <a href="#sec-sho-pilot">Section 19.2.1</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">fhk_pilot</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">pilot</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">gvkey</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">fhk_pilot</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"pilot"</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The final sample <code>sho_accruals</code> is created in the following code and involves a number of steps. We first merge data from FHK’s <code>sho_data</code> with <code>fhk_firm_years</code> to produce the sample firm-years and treatment indicator for FHK. As <code>fhk_firm_years</code> can contain multiple years for each firm, so we expect each row in <code>sho_data</code> to match multiple rows in <code>fhk_firm_years</code>. At the same time, some <code>gvkey</code> values link with multiple PERMNOs, so some rows in <code>fhk_firm_years</code> will match multiple rows in <code>sho_data</code>. As such, we set <code>relationship = "many-to-many"</code> in this join below. We then merge the resulting data set with <code>df_controls</code>, which contains data on controls. The final data merge brings in data on performance-matched discretionary accruals from <code>pm_disc_accruals_sorted</code>. Finally, following FHK, we winsorize certain variables using the <code>[winsorize()](https://rdrr.io/pkg/farr/man/winsorize.html)</code> function from the <code>farr</code> package to do this here.<a href="#fn16">16</a></p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">win_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"at"</span>, <span class="st">"mtob"</span>, <span class="st">"leverage"</span>, <span class="st">"roa"</span>, <span class="st">"da_adj"</span>, <span class="st">"acc_at"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sho_accruals</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">fhk_firm_years</span>, </span>
<span>             by <span class="op">=</span> <span class="st">"gvkey"</span>,</span>
<span>             relationship <span class="op">=</span> <span class="st">"many-to-many"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">datadate</span>, <span class="va">pilot</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fyear <span class="op">=</span> <span class="fu">year</span><span class="op">(</span><span class="va">datadate</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fu">month</span><span class="op">(</span><span class="va">datadate</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">df_controls</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">pmdas</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">win_vars</span><span class="op">)</span>,</span>
<span>                \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">winsorize</span><span class="op">(</span><span class="va">x</span>, prob <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="discussion-questions-and-exercises" class="level3" data-number="11.6.3"><h3 data-number="11.6.3" class="anchored" data-anchor-id="discussion-questions-and-exercises">
<span class="header-section-number">11.6.3</span> Discussion questions and exercises</h3>
<ol type="1">
<li>What would be the effect of replacing the code that creates <code>ff_data</code> above with the following code? What changes would we need to make to the code creating <code>for_disc_accruals</code> in <code>get_das()</code> to use this modified version of <code>ff_data</code>?</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ff_data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">get_ff_ind</span><span class="op">(</span><span class="fl">48</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>sich <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">sic_min</span>, to <span class="op">=</span> <span class="va">sic_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">sich</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li><p>What issue is <code>filter(row_number() == 1)</code> addressing in the code above? What assumptions are implicit in this approach? Do these assumptions hold in this case? What would be an alternative approach to address the issue?</p></li>
<li><p>Why is <code>filter(fyear == lag(fyear) + 1)</code> required in the creation of <code>controls_raw</code>?</p></li>
<li><p>Does the argument for using <code>salerect_c_at * b_sale_c_at</code> in creating non-discretionary accruals make sense to you? How do <span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> explain this?</p></li>
<li><p>Does the code above ensure that a performance-matched control firm is used as a control just once? If so, which aspect of the code ensures this is true? If not, how might you ensure this and does this cause problems? (Just describe the approach in general; no need to do this.)</p></li>
<li><p>What are FHK doing in the creation of <code>controls_filled</code>? (Hint: The key “verb” is <code>[fill()](https://tidyr.tidyverse.org/reference/fill.html)</code>.) Does this seem appropriate? Does doing this make a difference?</p></li>
<li><p>What are FHK doing in the creation of <code>df_controls</code> from <code>controls_fyear</code>? Does this seem appropriate? Does doing this make a difference?</p></li>
</ol></section><section id="fhk-regression-analysis" class="level3" data-number="11.6.4"><h3 data-number="11.6.4" class="anchored" data-anchor-id="fhk-regression-analysis">
<span class="header-section-number">11.6.4</span> FHK: Regression analysis</h3>
<p>FHK consider a number of regression specifications including: with and without controls, with and without firm fixed effects, and with standard errors clustered by firm alone and clustered by firm and year. We make a small function (<code>reg_year_fe()</code>) that calculates variables used in the regression (like <code>during</code> and <code>post</code>) and allows us to specify each of these different options, to change the dependent variable from the default (<code>dv = "da_adj"</code>) and to supply a different data set. This function returns a fitted model that is estimated using <code>[feols()](https://lrberge.github.io/fixest/reference/feols.html)</code> from the <code>fixest</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ctrls_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log(at)"</span>, <span class="st">"mtob"</span>, <span class="st">"roa"</span>, <span class="st">"leverage"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_year_fe</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">dv</span> <span class="op">=</span> <span class="st">"da_adj"</span>,</span>
<span>                        <span class="va">controls</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">firm_fe</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">cl_2</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                        <span class="va">vcov</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="fu">year</span><span class="op">(</span><span class="va">datadate</span><span class="op">)</span>,</span>
<span>           during <span class="op">=</span> <span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2005</span>, <span class="fl">2006</span>, <span class="fl">2007</span><span class="op">)</span>,</span>
<span>           post <span class="op">=</span> <span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2008</span>, <span class="fl">2009</span>, <span class="fl">2010</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">str_c</span><span class="op">(</span><span class="va">dv</span>, <span class="st">" ~ pilot * (during + post) "</span>,</span>
<span>                 <span class="fu">if_else</span><span class="op">(</span><span class="va">controls</span>, </span>
<span>                         <span class="fu">str_c</span><span class="op">(</span><span class="st">" + "</span>, <span class="fu">str_c</span><span class="op">(</span><span class="va">ctrls_list</span>, </span>
<span>                                            collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span>,</span>
<span>                    <span class="fu">if_else</span><span class="op">(</span><span class="va">firm_fe</span>, <span class="st">"| gvkey + year "</span>, <span class="st">"| year "</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">vcov</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vcov</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu">if_else</span><span class="op">(</span><span class="op">!</span><span class="va">cl_2</span>, <span class="st">"~ gvkey "</span>, <span class="st">"~ year + gvkey"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu">feols</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>, </span>
<span>        vcov <span class="op">=</span> <span class="va">vcov</span>,</span>
<span>        notes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To facilitate the output of variations, we next make a function that runs regressions with and without controls and with and without firm fixed effects and returns a nicely formatted regression table.</p>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">make_reg_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">dv</span> <span class="op">=</span> <span class="st">"da_adj"</span>, <span class="va">cl_2</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">omit</span> <span class="op">&lt;-</span> <span class="fu">str_c</span><span class="op">(</span><span class="st">"^("</span>, <span class="fu">str_c</span><span class="op">(</span><span class="fu">str_replace_all</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"during"</span>, <span class="st">"post"</span>, <span class="va">ctrls_list</span><span class="op">)</span>,</span>
<span>                                            <span class="st">"[()]"</span>, <span class="st">"."</span><span class="op">)</span>, </span>
<span>                            collapse<span class="op">=</span><span class="st">"|"</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">run_reg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">controls</span>, <span class="va">firm_fe</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">reg_year_fe</span><span class="op">(</span><span class="va">df</span>, dv <span class="op">=</span> <span class="va">dv</span>, controls <span class="op">=</span> <span class="va">controls</span>, firm_fe <span class="op">=</span> <span class="va">firm_fe</span>,</span>
<span>                cl_2 <span class="op">=</span> <span class="va">cl_2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>controls <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                   firm_fe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fms</span> <span class="op">&lt;-</span> <span class="fu">pmap</span><span class="op">(</span><span class="va">params</span>, <span class="va">run_reg</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">notes</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span><span class="op">~</span><span class="va">term</span>,  <span class="op">~</span><span class="va">`1`</span>,  <span class="op">~</span><span class="va">`2`</span>, <span class="op">~</span><span class="va">`3`</span>, <span class="op">~</span><span class="va">`4`</span>,</span>
<span>                   <span class="st">"Firm FEs"</span>, <span class="st">"No"</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>, <span class="st">"Yes"</span>,</span>
<span>                   <span class="st">"Controls"</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">modelsummary</span><span class="op">(</span><span class="va">fms</span>,</span>
<span>               estimate <span class="op">=</span> <span class="st">"{estimate}{stars}"</span>,</span>
<span>               gof_map <span class="op">=</span> <span class="st">"nobs"</span>,</span>
<span>               stars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'*'</span> <span class="op">=</span> <span class="fl">.1</span>, <span class="st">'**'</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="st">'***'</span> <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>,</span>
<span>               coef_omit <span class="op">=</span> <span class="fu">str_c</span><span class="op">(</span><span class="fu">str_replace_all</span><span class="op">(</span><span class="va">ctrls_list</span>, <span class="st">"[()]"</span>, <span class="st">"."</span><span class="op">)</span>,</span>
<span>                                 collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span>,</span>
<span>               add_rows <span class="op">=</span> <span class="va">notes</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now use this function with our version of FHK’s data set (<code>sho_accruals</code>) to create the regression results reported in <a href="#tbl-baseline">Table&nbsp;19.3</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">make_reg_table</span><span class="op">(</span><span class="va">sho_accruals</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We next create a function that allows us to plot by-year coefficients for the treatment and control firms. (We leave the details of what this function is doing as an exercise for the reader below.)</p>
<div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_coefficients</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span>,</span>
<span>         value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">name</span>, <span class="st">"^year."</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">separate</span><span class="op">(</span><span class="va">name</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"pilot"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">":"</span>, fill <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu">str_replace</span><span class="op">(</span><span class="va">year</span>, <span class="st">"^year"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         pilot <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">pilot</span> <span class="op">==</span> <span class="st">"pilotTRUE"</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">value</span>, </span>
<span>             linetype <span class="op">=</span> <span class="va">pilot</span>, color <span class="op">=</span> <span class="va">pilot</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2012L</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_rect</span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">2005</span>, xmax <span class="op">=</span> <span class="fl">2007</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>              color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To produce <a href="#fig-coef-plot">Figure&nbsp;19.3</a>, we estimate one of the models above by year and feed the fitted model to <code>plot_coefficients()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sho_accruals</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu">year</span><span class="op">(</span><span class="va">datadate</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">feols</span><span class="op">(</span><span class="va">da_adj</span> <span class="op">~</span> <span class="va">year</span> <span class="op">*</span> <span class="va">pilot</span> <span class="op">-</span> <span class="va">pilot</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">at</span><span class="op">)</span> <span class="op">+</span> <span class="va">mtob</span> <span class="op">+</span> <span class="va">roa</span> <span class="op">+</span> <span class="va">leverage</span>,</span>
<span>        vcov <span class="op">=</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">gvkey</span>, data <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plot_coefficients</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercises-1" class="level3" data-number="11.6.5"><h3 data-number="11.6.5" class="anchored" data-anchor-id="exercises-1">
<span class="header-section-number">11.6.5</span> Exercises</h3>
<ol type="1">
<li>In words, how does <code>sho_accruals_alt</code> (defined below) differ from <code>sho_accruals</code>? Does using <code>sho_accruals_alt</code> in place of <code>sho_accruals</code> affect the regression results?</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">firm_years</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">controls_raw</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">datadate</span>, <span class="va">fyear</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sho_accruals_alt</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sho_r3000_gvkeys</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">firm_years</span>, by <span class="op">=</span> <span class="st">"gvkey"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">df_controls</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">pmdas</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"fyear"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">fyear</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">win_vars</span><span class="op">)</span>, <span class="va">winsorize</span>, prob <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li><p>In an online appendix, BDLYY say “FHK winsorize covariates for their covariate balance table at 1/99%. We inferred that they also winsorized accruals at this level. Whether they winsorize across sample years or within each year, they do not specify.” The code above winsorized within each year. How would you modify the code to winsorize “across sample years”? Does doing so make a difference?</p></li>
<li><p>How would you modify the code to winsorize at the 2%/98% level? Does this make a difference to the results? (<em>Hint</em>: With the <code>farr</code> package loaded, type <code>[? winsorize](https://rdrr.io/pkg/farr/man/winsorize.html)</code> in the R console to get help on this function.)</p></li>
<li><p>How would you modify the code to not winsorize at all? Does this make a difference to the results?</p></li>
<li><p>Some of the studies discussed by BDLYY exclude 2004 data from the sample. How would you modify the code above to do this here? Does excluding 2004 here make a significant difference?</p></li>
<li><p>What is the range of values for <code>year</code> in <code>sho_accruals</code>? Does this suggest any issues with the code <code>post = year %in% c(2008, 2009, 2010)</code> above? If so, does fixing any issue have an impact on the results reported above?</p></li>
<li><p>Would it make sense, in creating <code>perf</code> above, if we instead calculated <code>ib_at</code> as <code>if_else(at &gt; 0, ib / at, NA))</code>? What is the effect on the regression results if we use this modified calculation of <code>ib_at</code>? What do <span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> recommend on this point? (<em>Hint</em>: Use <code>pm_lag = FALSE</code> where applicable.)</p></li>
<li><p>Fang et al.&nbsp;(<a href="references.html#ref-Fang:2019tt">2019, p.&nbsp;10</a>) follow Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>), who “exclude observations for which the absolute value of total accruals-to-total assets exceeds one. This is a standard practice in the accounting literature because firms with such high total accruals-to-total assets are often viewed as extreme outliers. Nonetheless, the FHK results are robust to winsorizing the accrual measures at the 1% and 99% levels instead of excluding extreme outliers.” Does this claim hold up in the reproduction above? What happens if the <code>[filter()](https://dplyr.tidyverse.org/reference/filter.html)</code> on <code>abs(acc_at) &lt;= 1</code> is removed from the code above? (<em>Hint</em>: Use <code>drop_extreme = FALSE</code> where applicable.)</p></li>
<li><p>Explain what each line of the function <code>plot_coefficients()</code> before the line starting with <code>[ggplot()](https://ggplot2.tidyverse.org/reference/ggplot.html)</code> is doing. (<em>Hint</em>: It may be helpful to store the model that is fed to the function above in the variable <code>model</code> and then run the function line by line.)</p></li>
</ol>
<!-- ## Statistical inference --></section></section><section id="統計的推論" class="level2" data-number="11.7"><h2 data-number="11.7" class="anchored" data-anchor-id="統計的推論">
<span class="header-section-number">11.7</span> 統計的推論</h2>
<!-- One point of difference between FHK and BDLYY concerns clustered standard errors.  -->
<p>FHKとBDLYYの間の違いの一つは、クラスター標準誤差に関することである。 <!-- Fang et al. ([2016](references.html#ref-Fang:2016uy)) generally use “standard errors clustered by year and firm” ([2016, p.1269](references.html#ref-Fang:2016uy)), while Black et al. ([2019](references.html#ref-Black:2019vv)) advocate the use of standard errors clustered by firm.  --> Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>)は一般的に「年と企業でクラスタリングされた標準誤差」を使用しているが、Black et al.&nbsp;(<a href="references.html#ref-Black:2019vv">2019</a>)は企業でクラスタリングされた標準誤差の使用を提唱している。 <!-- Citing Cameron et al. ([2008](references.html#ref-Cameron:2008ws)), Black et al. ([2019, p.30](references.html#ref-Black:2019vv)) suggest that “clustered standard errors with a small number of clusters can be downward biased.”  --> Cameron et al.&nbsp;(<a href="references.html#ref-Cameron:2008ws">2008</a>)を引用して、Black et al.&nbsp;(<a href="references.html#ref-Black:2019vv">2019, p.30</a>)は「クラスタリングされた標準誤差は、クラスター数が少ない場合には下方バイアスになる可能性がある」と述べている。 <!-- In the context of FHK, there are thousands of firms, but a relatively small number of years, so clustering by year (or firm *and* year) may result in problematic standard error estimates (see [Section 5.6.6](stat-inf.html#sec-se-calcs)). --> FHKの文脈では数千の企業が存在しているが、比較的少数の年数であり、年でクラスタリング（または企業<em>および</em>年度でクラスタリング）を行うと、問題のある標準誤差の推定値が得られる可能性があります（<a href="stat-inf.html#sec-se-calcs">Section 5.6.6</a>を参照）。</p>
<!-- One approach to determining the appropriate clustering is more empirical.  -->
<p>適切なクラスタリングを決定するためのアプローチの一つは、より経験的なものである。 <!-- In this regard, it is useful to note that cluster-robust standard errors are a generalization of an idea from White ([1980](references.html#ref-White:1980aa)).  --> この点で、クラスター誤差の標準誤差は、White (<a href="references.html#ref-White:1980aa">1980</a>)のアイデアの一般化であることを指摘しておくと、有用である。 White (<a href="references.html#ref-White:1980aa">1980</a>) provides not only an estimator of standard errors that is robust to heteroskedasticity, but also a test of a null hypothesis of homoskedasticity. Intuitively, if the covariance matrix assuming heteroskedasticity is sufficiently different from that assuming homoskedasticity, then we may reject the null hypothesis of homoskedasticity. With a little algebra, it would be possible to develop a test analogous to that of White (<a href="references.html#ref-White:1980aa">1980</a>) of the null hypothesis of no clustering on variable (g). In practice, many researchers will, lacking a formally derived test, compare standard errors with and without clustering on variable (g) and elect to cluster on variable (g) when the standard errors when doing so seem significantly higher than when not doing so. This heuristic breaks down in the case of Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>) because standard errors are generally lower when clustering on firm and year than when clustering firm alone. However, if clustering on firm alone is appropriate, standard errors clustering on firm and year will provide noisier estimates than clustering on firm alone, and thus could be lower or higher in any given data set.</p>
<p>A more theoretical approach can be used in the setting of FHK because of our deeper understanding of the assignment mechanism. In this regard, it is important to note that cluster-robust standard errors address correlation in <em>both</em> (X) <em>and</em> () across units within clusters. To explore this (slightly) more formally, recall from <a href="stat-inf.html">Chapter 5</a> that the cluster-robust covariance matrix is estimated using the following expression:</p>
<p><span class="math display">
\begin{aligned}
\hat{V}(\hat{\beta}) =
(\boldsymbol{X}'\boldsymbol{X})^{-1} \hat{\boldsymbol{B}} (\boldsymbol{X}'\boldsymbol{X})^{-1}, \quad  \text{where} \quad  \hat{B} = \sum_{g = 1}^G \boldsymbol{X}'_g u_g u'_g \boldsymbol{X}_g
\end{aligned}
</span></p>
<p>where the observations grouped into <span class="math inline">G</span> clusters of <span class="math inline">N_g</span> observations for <span class="math inline">g</span> in <span class="math inline">{1, \dots, G}</span> , <span class="math inline">X_g</span> is the <span class="math inline">N_g \times K</span> matrix of regressors, and <span class="math inline">u_g</span> is the <span class="math inline">N_g</span> -vector of residuals for cluster <span class="math inline">g</span> .</p>
<p>If we have a single regressor, demeaned <span class="math inline">x</span> with no constant term and two firms ( <span class="math inline">i</span> and <span class="math inline">j</span> ) in a cluster, then the contribution of that cluster to <span class="math inline">\hat{B}</span> will be</p>
<p><span class="math display">
\begin{aligned}
\begin{bmatrix}
x_i &amp; x_j
\end{bmatrix}
\begin{bmatrix}
u_i \\
u_j
\end{bmatrix}
\begin{bmatrix}
u_i &amp; u_j
\end{bmatrix}
\begin{bmatrix}
x_i \\
x_j
\end{bmatrix} &amp;=
\begin{bmatrix}
x_i &amp; x_j
\end{bmatrix}
\begin{bmatrix}
u_i^2 &amp; u_i u_j \\
u_i u_j &amp; u_j^2
\end{bmatrix}
\begin{bmatrix}
x_i \\
x_j
\end{bmatrix} \\
&amp;=
\begin{bmatrix}
x_i &amp; x_j
\end{bmatrix}
\begin{bmatrix}
x_i u_i^2 + x_j u_i u_j \\
x_i u_i u_j + x_j u_j^2
\end{bmatrix} \\
&amp;=
\begin{bmatrix}
x_i^2 u_i^2 + x_i x_j u_i u_j \\
x_i x_j u_i u_j + x_j^2 u_j^2
\end{bmatrix}
\end{aligned}
</span></p>
<p>Now, if <span class="math inline">x_i</span> and <span class="math inline">x_j</span> are uncorrelated then, even if <span class="math inline">\epsilon_i</span> and <span class="math inline">\epsilon_j</span> are correlated, this resolves in expectation to</p>
<p><span class="math display">
\begin{bmatrix}
x_i^2 \sigma _i^2 \\
x_j^2 \sigma _j^2
\end{bmatrix}
</span></p>
<!-- which is the expectation of the analogous component of the heteroskedasticity-robust estimator from White ([1980](references.html#ref-White:1980aa)).  -->
<p>これは、White (<a href="references.html#ref-White:1980aa">1980</a>)の不均一分散頑健推定量の類似の成分の期待値である。 <!-- In the setting of Fang et al. ([2016](references.html#ref-Fang:2016uy)), the “\(x\)” of primary interest is the Reg SHO pilot indicator, which is assumed to be randomly assigned, and thus (in expectation) uncorrelated across firms.  --> Fang et al.&nbsp;(<a href="references.html#ref-Fang:2016uy">2016</a>)の設定では、主要な関心事である「(x)」は、ランダムに割り当てられると仮定されているReg SHOパイロット指標であり、したがって（期待値では）企業間で相関がない。 <!-- For this reason, we do not expect cross-sectional dependence to affect standard error estimates on average.  --> このため、クロスセクション依存性が平均的に標準誤差推定値に影響を与えることはないと予想される。 <!-- On the other hand, the Reg SHO pilot indicator is perfectly correlated over time within firm, so any serial dependence in errors within firm over time will lead to effects of time-series dependence on standard error estimates.  --> 一方、Reg SHOパイロット指標は、企業内で時間経過とともに完全に相関しているため、時間経過にわたる企業内の誤差の直列依存性が標準誤差推定値に時間系列依存性の影響を与える。 <!-- This (somewhat loose) theoretical analysis suggests we should cluster by firm (time-series dependence), but not by year (cross-sectional dependence), as suggested by Black et al. ([2019, p. 12](references.html#ref-Black:2019vv)). --> この（やや緩い）理論的分析は、Black et al.&nbsp;(<a href="references.html#ref-Black:2019vv">2019, p.&nbsp;12</a>)が示唆するように、企業（時間系列依存性）でクラスタリングするべきであるが、年でクラスタリングするべきではないことを示唆している。</p>
<!-- However, the assumed random assignment of treatment allows us to adopt an alternative approach to statistical inference that is agnostic to the form of clustering in the data.  -->
<p>しかし、仮定されたランダムな処置の割り当てにより、データのクラスタリングの形式に無関心な統計推論の代替アプローチを採用することができる。 <!-- This approach is known as **randomization inference** and builds on the **Fisher sharp null** hypothesis of no effect of any kind.  --> このアプローチは<strong>ランダム化推論</strong>(randomization inference)と呼ばれ、いかなる影響も存在しないというフィッシャーの<strong>強い帰無仮説</strong>(Fisher sharp null hypothesis)に基づく。 <!-- This is a “sharp null” because it is more restrictive that a null hypothesis of zero mean effect, which could be true even if half the observations had a treatment effect of +1 and half the observations had a treatment effect of -1, in which case the Fisher sharp null would not be true even though null hypothesis of zero mean effect is true. --> これは「シャープの強い帰無仮説」と呼ばれるのは、ゼロ平均効果の帰無仮説よりも制約が厳しいためである。たとえば、観測の半数が <span class="math inline">+1</span> の処置効果を持ち、残りの半数が <span class="math inline">-1</span> の処置効果を持つ場合、ゼロ平均効果の帰無仮説は成立するが、フィッシャーの強い帰無仮説は成立しない。</p>
<!-- Under the Fisher sharp null hypothesis and with random assignment to treatment, in principle we can evaluate the distribution of any given test statistic by considering all possible assignments.  -->
<p>フィッシャーの強い帰無仮説の下で、処置へのランダムな割り当てが行われた場合、原則として、すべての可能な割り当てを考慮することで、任意の検定統計量の分布を評価することができる。 <!-- Focusing on the 2954 firms that the SEC focused on as its initial sample, if assignment to treatment were purely random, then any other assignment of treatment to 985 was as likely as the one chosen.  --> 初期サンプルとしてSECが焦点を当てた2954社に焦点を当てると、処置の割り当てが純粋にランダムであれば、985社への処置の他の割り当ては、選択された割り当てと同じくらい可能性があった。 <!-- Given that the Fisher sharp null implies that there was no impact of treatment assignment on outcomes, we know what the distribution of the test statistic would have been if the SEC had chosen any one of those alternative assignments because the outcomes would have been exactly the same.  --> フィッシャーの強い帰無仮説が処置の割り当てが結果に影響を与えなかったことを意味するので、SECが他の割り当てのいずれかを選択した場合、テスト統計量の分布がどのようになるかを知っている。なぜなら、結果はまったく同じだったからである。 <!-- With smaller samples, we might proceed to calculate the test statistic for every possible assignment and thereby construct the exact distribution of the test statistic under the Fisher sharp null.[17] --> サンプルが小さい場合、すべての可能な割り当てに対して検定統計量を計算し、フィッシャーの強い帰無仮説の下での検定統計量の正確な分布を構築することができる。[^17] <!-- But in our case, there will be a huge number of ways to choose 985 treatment firms from 2954 possibilities; so a more feasible approach is to draw a random sample of possible assignments and use the empirical distribution of the test statistic for that random sample as an approximation for the exact distribution. --> しかし、我々の場合、2954の可能性から985の処置企業を選ぶ方法は膨大であるため、可能な割り当てのランダムサンプルを抽出し、そのランダムサンプルの検定統計量の経験分布を正確な分布の近似として使用することがより現実的である。</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_coef_rand</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">treatment</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">sho_accruals</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">pilot</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pilot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">pilot</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pilot</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">reg_data_alt</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">sho_accruals</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">pilot</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">inner_join</span><span class="op">(</span><span class="va">treatment</span>, by <span class="op">=</span> <span class="st">"gvkey"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">reg_data_alt</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">reg_year_fe</span><span class="op">(</span>controls <span class="op">=</span> <span class="cn">TRUE</span>, firm_fe <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"term"</span>, values_from <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>iteration <span class="op">=</span> <span class="va">i</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The test statistic we are interested in here is the coefficient on $PILOT \times DURING$ . -->
<p>ここで興味がある検定統計量は、<span class="math inline">PILOT \times DURING</span> の係数である。 <!-- Below we calculate the p-value of the coefficients on variables involving $PILOT$ using the empirical distribution of coefficients, and the standard errors associated with the coefficients as the standard deviation of those coefficients. --> 以下では、<span class="math inline">PILOT</span> に関する変数の係数について、係数の経験的分布を用いてp値を計算し、係数に対応する標準誤差をそれらの係数の標準偏差として求める。</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span></span>
<span><span class="va">rand_results</span> <span class="op">&lt;-</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="va">get_coef_rand</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">system_time</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rand_results</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">future_map</span><span class="op">(</span><span class="va">get_coef_rand</span>, </span>
<span>             .options <span class="op">=</span> <span class="fu">furrr_options</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">system_time</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- In the following, we run regressions with standard errors based on clustering by firm and year, by firm alone, and using randomization inference.  -->
<p>以下では、企業と年によるクラスタリング、企業のみによるクラスタリング、およびランダム化推論を用いた標準誤差を基に回帰を実行する。 <!-- We start by running regressions—with controls and firm fixed effects—with standard errors based on clustering by firm (`"CL-i"`) and by firm and year (`"CL-2"`). --> 最初に、企業によるクラスタリング（<code>"CL-i"</code>）と企業と年によるクラスタリング（<code>"CL-2"</code>）に基づいた標準誤差を用いて、コントロールと企業固定効果を持つ回帰を実行する。</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">reg_year_fe</span><span class="op">(</span><span class="va">sho_accruals</span>, cl_2 <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>            <span class="fu">reg_year_fe</span><span class="op">(</span><span class="va">sho_accruals</span>, cl_2 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- We extract the variance-covariance matrices for each of these two models and place them in the list `vcovs`. -->
<p>これら2つのモデルの分散共分散行列を抽出し、それらをリスト<code>vcovs</code>に配置する。</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vcovs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html">vcov</a></span><span class="op">(</span><span class="va">fms</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html">vcov</a></span><span class="op">(</span><span class="va">fms</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Next, we add a third model for which we will calculate standard errors using randomization inference (`"RI"`).  -->
<p>次に、ランダム化推論（<code>"RI"</code>）を用いて標準誤差を計算するための第3のモデルを追加する。 <!-- The coefficients stored in `fms` for this third model can be taken from either of the two models already stored there. --> この第3のモデルの<code>fms</code>に格納された係数は、すでに格納されている2つのモデルのどちらかから取得できる。</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fms</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fms</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- For the variance-covariance matrix, we use `CL-i` standard errors as the starting point. -->
<p>分散共分散行列については、<code>CL-i</code>標準誤差を出発点として使用する。 <!-- Then we replace the elements for coefficients on variables involving $PILOT$ using the empirical distribution stored in `rand_results`. --> <code>rand_results</code>に格納された経験的分布を用いて、<span class="math inline">PILOT</span> に関する変数の係数の要素を置き換える。</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vcov</span> <span class="op">&lt;-</span> <span class="va">vcovs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">vcov</span><span class="op">[</span><span class="st">"pilotTRUE:duringTRUE"</span>, <span class="st">"pilotTRUE:duringTRUE"</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">rand_results</span><span class="op">[[</span><span class="st">"pilotTRUE:duringTRUE"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">vcov</span><span class="op">[</span><span class="st">"pilotTRUE:postTRUE"</span>, <span class="st">"pilotTRUE:postTRUE"</span><span class="op">]</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">rand_results</span><span class="op">[[</span><span class="st">"pilotTRUE:postTRUE"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">vcovs</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">vcov</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Results of this analysis are provided in [Table 19.4](#tbl-rand-inf). -->
<p>この分析の結果は、<a href="#tbl-rand-inf">Table&nbsp;19.4</a>に示されている。</p>
<div class="cell">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">se_notes</span> <span class="op">&lt;-</span> <span class="fu">tribble</span><span class="op">(</span><span class="op">~</span><span class="va">term</span>,  <span class="op">~</span><span class="va">`1`</span>,  <span class="op">~</span><span class="va">`2`</span>, <span class="op">~</span><span class="va">`3`</span>,</span>
<span>                    <span class="st">"SEs"</span>, <span class="st">"CL-i"</span>, <span class="st">"CL-2"</span>, <span class="st">"RI"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">modelsummary</span><span class="op">(</span><span class="va">fms</span>, vcov <span class="op">=</span> <span class="va">vcovs</span>, </span>
<span>             estimate <span class="op">=</span> <span class="st">"{estimate}{stars}"</span>,</span>
<span>             gof_map <span class="op">=</span> <span class="st">"nobs"</span>,</span>
<span>             stars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'*'</span> <span class="op">=</span> <span class="fl">.1</span>, <span class="st">'**'</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="st">'***'</span> <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>,</span>
<span>             coef_omit <span class="op">=</span> <span class="st">"^(during|post|pilot)TRUE$"</span>,</span>
<span>             add_rows <span class="op">=</span> <span class="va">se_notes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ### Exercises -->
<section id="練習問題" class="level3" data-number="11.7.1"><h3 data-number="11.7.1" class="anchored" data-anchor-id="練習問題">
<span class="header-section-number">11.7.1</span> 練習問題</h3>
<!-- 1. In the function `get_coef_rand()`, we first created the data set `treatment`, then merged this with `reg_data_alt`.  -->
<ol type="1">
<li>
<code>get_coef_rand()</code>関数では、まずデータセット<code>treatment</code>を作成し、次にこれを<code>reg_data_alt</code>とマージする。 <!-- Why did we do it this way rather than simply applying the line `mutate(pilot = sample(pilot, size = length(pilot), replace = FALSE))` directly to `reg_data_alt`? --> なぜ、<code>reg_data_alt</code>に直接<code>mutate(pilot = sample(pilot, size = length(pilot), replace = FALSE))</code>を適用するのではなく、このように行ったのか。</li>
</ol>
<!-- 2. Using randomization inference, calculate a p-value for a one-sided alternative hypothesis that $H_1: \beta < 0$ where $\beta$ is the coefficient on $PILOT \times DURING$ .  --><ol start="2" type="1">
<li>ランダム化推論を使用して、<span class="math inline">H_1: \beta &lt; 0</span>（ここで、 <span class="math inline">\beta</span> は <span class="math inline">PILOT \times DURING</span> の係数である）の片側の代替仮説の <span class="math inline">p</span> 値を計算する。 <!-- (*Hint*: You should not need to run the randomization again; modifying the calculation of `p_value` should suffice.) --> （<em>ヒント</em>：ランダム化を再実行する必要はありません。<code>p_value</code>の計算を変更するだけで十分である。）</li>
</ol>
<!-- 3. What is the empirical standard error implied by the distribution of coefficients in `rand_results`?  --><ol start="3" type="1">
<li>
<code>rand_results</code>の係数の分布によって示される経験的標準誤差は何か？ <!-- Is it closer to the two-way cluster robust standard errors obtained in estimating with `cl_2 = TRUE` or with `cl_2 = FALSE`?  --> <code>cl_2 = TRUE</code> または <code>cl_2 = FALSE</code> で推定した2方向クラスター頑健標準誤差により近いか？ <!-- Why might it be preferable to calculate p-values under randomization inference using the empirical distribution of the test statistic, instead of calculating these from t-statistics based on the estimated coefficient and the empirical standard error?  --> 推定された係数と経験的標準誤差に基づいたt統計量からp値を計算する代わりに、ランダム化推論を用いて検定統計量の経験的分布を用いてp値を計算することが望ましい理由は何か？ <!-- Would we get different p-values using the former approach? --> 前者のアプローチを使用して異なるp値を得ることができるか？</li>
</ol>
<!-- 4. Why did we not use the empirical standard error implied by the distribution of coefficients in `rand_results` to calculate standard errors for the control variables (e.g., `log(at)`)? --><ol start="4" type="1">
<li>
<code>rand_results</code>の係数の分布によって示される経験的標準誤差を使用して、制御変数（例：<code>log(at)</code>）の標準誤差を計算しなかった理由は何か？</li>
</ol>
<!-- ## Causal diagrams --></section></section><section id="因果ダイアグラム" class="level2" data-number="11.8"><h2 data-number="11.8" class="anchored" data-anchor-id="因果ダイアグラム">
<span class="header-section-number">11.8</span> 因果ダイアグラム</h2>
<!-- It is important to note that we *observe* total accruals, not discretionary accruals.  -->
<p>我々は、裁量的アクルーアルではなく、総アクルーアルを<em>観測</em>していることに注意することが重要である。 <!-- Instead we need to construct *measures* of discretionary accruals.  --> 代わりに、裁量的アクルーアルの<em>尺度</em>を構築する必要がある。 <!-- The Jones ([1991](references.html#ref-Jones:1991vx)) model of discretionary accruals “controls for” sales growth and PP&E and the @Kothari:2005aa  model additionally “controls for” performance. --> 裁量的アクルーアルのJones (<a href="references.html#ref-Jones:1991vx">1991</a>)モデルは、売上高成長とPP&amp;Eを「制御」し、<span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> モデルはさらにパフォーマンスを「コントロール」している。</p>
<!-- Assuming that the causal diagram below is correct, we get unbiased estimates of causal effects whether we “control for” pre-treatment outcome values (e.g., using DiD) or not (e.g., using *POST*), and it is not clear that we need to control for other factors that drive total accruals.  -->
<p>以下の因果図が正しいと仮定すると、前処置の結果値（例：DiDを使用）を「制御」するかどうか（例：<em>POST</em>を使用）に関係なく、因果効果のバイアスのない推定値を得ることができ、総アクルーアルを駆動する他の要因を制御する必要があるかどうかは明確ではない。 <!-- If being a Reg SHO pilot firm leads to a reduction in earnings management, we should observe lower *total* accruals, even if we posit that the effect is through discretionary accruals, which we do not observe directly.  --> Reg SHOのパイロット企業であることが収益管理の低下につながる場合、我々は、我々が直接観測していない裁量的アクルーアルを通じて効果があると仮定していても、より低い<em>総</em>アクルーアルを観測するはずである。 <!-- If we accept this causal diagram, then the decision as to which factors to control for is—like the choice between *DiD*, *POST*, and *ANCOVA* - a question of statistical efficiency rather than bias.  --> この因果図を受け入れると、制御する要因の選択は、<em>DiD</em>、<em>POST</em>、<em>ANCOVA</em>の選択と同様に、バイアスではなく統計的効率性の問題である。</p>
<!-- In this context, it is perhaps useful to consider causal diagrams to sharpen our understanding of the issues, which we explore in the discussion questions below, as matters can be more complicated if the causal diagram in [Figure 19.4](#fig-sho-causal) is incomplete. -->
<p>この文脈では、<a href="#fig-sho-causal">Figure&nbsp;19.4</a>の因果図が不完全である場合、問題が複雑になる可能性があるため、問題をより鮮明に理解するために因果図を考慮することが役立つかもしれない。</p>
<!-- ###  Discussion questions -->
<section id="ディスカッション課題-1" class="level3" data-number="11.8.1"><h3 data-number="11.8.1" class="anchored" data-anchor-id="ディスカッション課題-1">
<span class="header-section-number">11.8.1</span> ディスカッション課題</h3>
<!-- 1. What features of [Figure 19.4](#fig-sho-causal) imply that we do not need to control for performance, sales, and PP&E in estimating the causal effect of Reg SHO on accruals?  -->
<ol type="1">
<li>
<a href="#fig-sho-causal">Figure&nbsp;19.4</a>のどの特徴が、Reg SHOが総勘定科目に対する因果効果を推定する際に、パフォーマンス、売上高、PP&amp;Eを制御する必要がないことを示しているのか。 <!-- What is the basis for assuming these features in the causal diagram? --> これらの特徴を因果図で仮定する根拠は何か。</li>
</ol>
<!-- 2. Black et al. ([2024](references.html#ref-Black:2022tz)) report that “over 60 papers in accounting, finance, and economics report that suspension of the price tests had wide-ranging indirect effects on pilot firms, including on earnings management, investments, leverage, acquisitions, management compensation, workplace safety, and more (see Internet Appendix, Table IA-1 for a summary).”  --><ol start="2" type="1">
<li>Black et al.&nbsp;(2024)は、「会計、ファイナンス、経済学の60以上の論文が、価格テストの停止がパイロット企業に間接的な影響を及ぼし、収益管理、投資、レバレッジ、買収、経営者の報酬、職場安全性などに広範囲の影響を及ぼしたことを報告している（Internet Appendix, Table IA-1を参照）」と報告している。 <!-- In light of the Internet Appendix of Black et al. ([2024](references.html#ref-Black:2022tz)), is there any evidence that Reg SHO might plausibly have an effect on performance, sales growth, or PP&E?  --> Black et al.&nbsp;(2024)のInternet Appendixを踏まえると、Reg SHOがパフォーマンス、売上成長、またはPP&amp;Eに影響を与える可能性があるかどうかについての証拠はあるか。 <!-- If so, how would [Figure 19.4](#fig-sho-causal) need to be modified to account for these consequences?  --> もしそうであれば、これらの結果を考慮するために<a href="#fig-sho-causal">Figure&nbsp;19.4</a>をどのように修正する必要があるか。 <!-- What would be the implications of these changes on the appropriate tests for estimating the causal effects of Reg SHO on accruals? --> これらの変更が、Reg SHOがアクルーアルに対する因果効果を推定するための適切な検定に与える影響は何か。</li>
</ol>
<!-- 3. Produce a regression table like [Table 19.3](#tbl-baseline) and a plot like [Figure 19.3](#fig-coef-plot), but using discretionary accruals *without* performance matching instead of performance-matched discretionary accruals.  --><ol start="3" type="1">
<li>
<a href="#tbl-baseline">Table&nbsp;19.3</a>のような回帰結果の表と<a href="#fig-coef-plot">Figure&nbsp;19.3</a>のようなプロットを作成しなさい。ただしパフォーマンスマッチング裁量的アクルーアルではなく、パフォーマンスマッチングを行わない裁量的アクルーアルを使用なさい。 <!-- How do you interpret these results? --> これらの結果をどのように解釈しますか。</li>
</ol>
<!-- 4. Produce a regression table and a plot like the ones in the FHK replication above, but using total accruals instead of discretionary accruals and excluding controls (so the coefficients will be simple conditional sample means).  --><ol start="4" type="1">
<li>FHKのレプリケーションのような回帰表とプロットを作成しなさい。ただし、裁量的アクルーアルの代わりに総アクルーアルを使用し、コントロールを除外しなさい（したがって、係数は単純な条件付きサンプル平均になります）。 <!-- How do you interpret these results? --> これらの結果をどのように解釈しますか。</li>
</ol>
<!-- 5. Suppose you had been brought in by the SEC to design a study examining the research question examined by FHK in the form of a registered report.  --><ol start="5" type="1">
<li>SECによって、FHKが検討した研究問題を登録された報告書の形で調査する研究を設計するように依頼されたとする。 <!-- What analyses would you conduct to try to understand the best research design?  --> 最適な研究設計を理解するためにどのような分析を行いますか。 <!-- For example, how would you choose between *DiD*, *POST*, *ANCOVA*, and other empirical approaches?  --> たとえば、<em>DiD</em>、<em>POST</em>、<em>ANCOVA</em>、およびその他の経験的アプローチの間でどのように選択するのか？ <!-- What controls would you include?  --> どのようなコントロールを含めるのか？ <!-- How would you decide how to include controls?  --> どのようにしてコントロールを含めるかを決定するのか？ <!-- (For example, one could control for performance by including performance as a regressor in the model of earnings management, by matching on performance, or by including performance in the main regression specification.)  --> （たとえば、パフォーマンスを収益管理のモデルの回帰変数として含める、パフォーマンスにマッチングする、またはパフォーマンスを主要な回帰仕様に含めることで、パフォーマンスを制御することができる。） <!-- How would you calculate standard errors?  --> 標準誤差はどのように計算するのか？ <!-- Discuss how your proposed empirical test differs from that of FHK.  --> 提案された経験的テストがFHKのものとどのように異なるかについて議論しなさい。 <!-- Would you have reported similar results to what FHK reported? --> FHKが報告した結果と同様の結果を報告するか？</li>
</ol>
<!-- 6. Suppose that FHK’s empirical analysis had produced a positive effect of Reg SHO on earnings management?  --><ol start="6" type="1">
<li>FHKの実証分析が利益マネジメントに対するReg SHOの正の効果を示したと仮定する。 <!-- Would this imply a lack of support for their hypotheses?  --> これは彼らの仮説を支持しないことを意味するか？ <!-- Do you believe that publication in the *Journal of Finance* depended on finding a negative effect? --> <em>Journal of Finance</em>での発表が負の効果を見つけることに依存していたと思うか？</li>
</ol>
<!-- 7. What implications would there have been for publication of FHK in the *Journal of Finance* if they had failed to find an effect of Reg SHO on earnings management? --><ol start="7" type="1">
<li>Reg SHOが収益管理に与える影響を見つけることができなかった場合、FHKの<em>Journal of Finance</em>での発表にはどのような影響があったか。</li>
</ol>
<!-- ## Causal mechanisms --></section></section><section id="因果メカニズム" class="level2" data-number="11.9"><h2 data-number="11.9" class="anchored" data-anchor-id="因果メカニズム">
<span class="header-section-number">11.9</span> 因果メカニズム</h2>
<!-- Black et al. ([2024](references.html#ref-Black:2022tz)) suggest a number of possible causal channels through which the Reg SHO experiment could have affected the behavior of firms or third parties, including short interest, returns, price efficient, and “manager fear”.  -->
<p>Black et al.&nbsp;(2024)は、Reg SHO実験が企業や第三者の行動に影響を与える可能性のあるいくつかの因果関係を示唆している。これには、ショートインタレスト、リターン、価格効率、および「manager fear」が含まれる。 <!-- On the last of these, Black et al. ([2024, p. 4](references.html#ref-Black:2022tz)) suggest that “even if the Reg SHO experiment did not actually affect short interest or returns, pilot firm managers could have feared being targeted by short sellers and taken pre-emptive actions.” --> 最後のものに関して、Black et al.&nbsp;(2024, p.4)は、「Reg SHO実験がショートインタレストやリターンに実際に影響を与えなかったとしても、パイロット企業の経営者はショートセラーに狙われることを恐れ、予防的な行動を取る可能性がある」と述べている。</p>
<!-- Black et al. ([2024, p. 5133](references.html#ref-Black:2022tz)) argue that “if firm managers were fearful that relaxing the price tests would affect them, one might expect them to voice concerns in various ways: speaking with business news reporters; writing to the SEC when it sought public comments, or seeking meetings with SEC officials to express opposition. … We searched the business press during 2003 when the rule was proposed, in 2004 when the experiment was announced, in 2006 when the SEC proposed repeal … We found no evidence of manager opposition.” -->
<p>Black et al.&nbsp;(2024, p.5133) は「もし企業の経営者が、価格テストの緩和が自社に影響を及ぼすことを恐れていたのであれば、さまざまな方法で懸念を表明すると考えられる。例えば、ビジネスニュースの記者に話す、SEC（証券取引委員会）が意見を募集した際に書面で意見を提出する、あるいはSEC当局者との面会を求めて反対意見を伝えるなどである。… 私たちは、規則が提案された2003年、実験が発表された2004年、SECが撤廃を提案した2006年の間に、ビジネス報道を調査した。しかし、経営者による反対の証拠は見つからなかった。」 と主張している。</p>
<!-- Black et al. (2024, p. 5134](references.html#ref-Black:2022tz)) suggest that “FHK rely on the manager fear channel. They conjecture that, in response to a greater threat of short selling, pilot firms’ managers reduced earnings management to preemptively deter short sellers.” -->
<p>Black et al.&nbsp;(2024, p.5134) は次のように示唆している。「FHK は、経営者の恐怖チャネルに依拠している。彼らは、空売りの脅威が高まることに対応して、パイロット企業の経営者が空売り投資家を事前に抑止するために、利益操作を抑制したと推測している。」</p>
<!-- ###  Discussion questions -->
<section id="ディスカッション課題-2" class="level3" data-number="11.9.1"><h3 data-number="11.9.1" class="anchored" data-anchor-id="ディスカッション課題-2">
<span class="header-section-number">11.9.1</span> ディスカッション課題</h3>
<!-- 1. Do you agree with the assertion of Black et al. ([2024](references.html#ref-Black:2022tz)) that “FHK rely on the manager fear channel”? -->
<ol type="1">
<li>Black et al.&nbsp;(2024)の主張「FHK は、経営者の恐怖チャネルに依存している」と同意するか？ <!-- What causal mechanisms are suggested in Fang et al. ([2016](references.html#ref-Fang:2016uy))?  --> Fang et al.&nbsp;(2016)では、どのような因果メカニズムが示唆されているか？ <!-- What evidence do Fang et al. ([2016](references.html#ref-Fang:2016uy)) offer in support of these mechanisms? --> Fang et al.&nbsp;(2016)は、これらのメカニズムを支持する証拠をどのように提供しているか？</li>
</ol>
<!-- 2. Evaluate the response of Fang et al. ([2019](references.html#ref-Fang:2019tt)) to Black et al. ([2024](references.html#ref-Black:2022tz)) as it relates to causal mechanisms? --><ol start="2" type="1">
<li>因果メカニズムに関連するFang et al.&nbsp;(2019)のBlack et al.&nbsp;(2024)への反応を評価しなさい。</li>
</ol>
<!-- 3. Do you think evidence of causal mechanisms is more or less important when using a natural experiment (i.e., an experiment outside the control of the researcher that is typically analysed after it has been run) than when conducting a randomized experiment?  --><ol start="3" type="1">
<li>研究者のコントロール外で実施される自然実験（つまり、通常は実施後に分析される実験）を行う場合、因果メカニズムの証拠は、無作為化実験を行う場合よりも重要だと思うか？ <!-- Explain your reasoning given the various issues raised in this chapter. --> この章で取り上げられたさまざまな問題を考慮して、その理由を説明しなさい。</li>
</ol>
<!-- ## Two-step regressions --></section></section><section id="二段階回帰" class="level2" data-number="11.10"><h2 data-number="11.10" class="anchored" data-anchor-id="二段階回帰">
<span class="header-section-number">11.10</span> 二段階回帰</h2>
<!-- @Chen:2018wh examine the question of statistical inference when residuals from one regression are used as a dependent variable in a subsequent regression, which they refer to as “the two-step procedure”.  -->
<p><span class="citation" data-cites="Chen:2018wh">Chen, Hribar, and Melessa (<a href="#ref-Chen:2018wh" role="doc-biblioref">2018</a>)</span> は、1つの回帰の残差が後続の回帰の従属変数として使用される場合の統計推論について検討しており、これを「2段階手続き」と呼んでいる。 <!-- For example, discretionary accruals measured using the Jones ([1991](references.html#ref-Jones:1991vx)) model are residuals from a regression of total accruals on changes in sales and PP&E.  --> たとえば、Jones (1991)モデルを用いた裁量的アクルーアルは、売上高の変化額とPP&amp;Eの変化額に関する回帰の残差である。 <!-- As we saw in Dechow et al. ([1995](references.html#ref-Dechow:1995wr)), which we covered in [Chapter 16](chap16_em.html), many papers examine how Jones ([1991](references.html#ref-Jones:1991vx)) model discretionary accruals relate to various posited incentives for earnings management. --> 第16章でカバーしたDechow et al.&nbsp;(1995)で見たように、Jones (1991)モデルの裁量的アクルーアルが、利益マネジメントの様々なインセンティブとどのように関連しているかを多くの論文が検討している。</p>
<!-- @Chen:2018wh [p.755] show that “the two-step procedure is likely to generate biased coefficients and t-statistics in many studies” and, drawing on the Frisch-Waugh-Lovell theorem (see [Section 3.3](reg-basics.html#sec-fwl)), propose using a single regression in place of the two-step procedure.  -->
<p><span class="citation" data-cites="Chen:2018wh">Chen, Hribar, and Melessa (<a href="#ref-Chen:2018wh" role="doc-biblioref">2018, 755</a>)</span>は、「2段階手続きは、多くの研究でバイアスのある係数とt統計量を生成する可能性が高い」と述べており、Frisch-Waugh-Lovellの定理（<a href="reg-basics.html#sec-fwl">Section 3.3</a>を参照）に基づいて、2段階手続きの代わりに単一の回帰を使用することを提案している。 <!-- In the case of the Jones ([1991](references.html#ref-Jones:1991vx)) model, this would entail including the regressors from the first step in same regression as the second step and using total accruals in place of discretionary accruals as the dependent variable. --> Jones (1991)モデルの場合、これは、第1ステップの回帰変数を第2ステップと同じ回帰式に含め、従属変数として裁量的アクルーアルの代わりに総アクルーアルを使用することを意味する。</p>
<!-- ### Discussion questions -->
<section id="ディスカッション課題-3" class="level3" data-number="11.10.1"><h3 data-number="11.10.1" class="anchored" data-anchor-id="ディスカッション課題-3">
<span class="header-section-number">11.10.1</span> ディスカッション課題</h3>
<!-- 1. What challenges would exist in implementing the single-regression recommendation of @Chen:2018wh  for a researcher using @Kothari:2005aa performance-matched discretionary accruals? -->
<ol type="1">
<li>
<span class="citation" data-cites="Chen:2018wh">Chen, Hribar, and Melessa (<a href="#ref-Chen:2018wh" role="doc-biblioref">2018</a>)</span> の単一回帰の推奨事項を使用する研究者が、<span class="citation" data-cites="Kothari:2005aa">Kothari, Leone, and Wasley (<a href="#ref-Kothari:2005aa" role="doc-biblioref">2005</a>)</span> のパフォーマンスマッチングされた裁量的アクルーアルを使用する際には、どのような課題があるか。</li>
</ol>
<!-- 2. Do you believe the issues raised by @Chen:2018wh with regard to two-step procedures also apply if using randomization inference? Why or why not? --><ol start="2" type="1">
<li>
<span class="citation" data-cites="Chen:2018wh">Chen, Hribar, and Melessa (<a href="#ref-Chen:2018wh" role="doc-biblioref">2018</a>)</span> が2段階手続きに関して提起した問題が、ランダム化推論を使用する場合にも当てはまると考えるのか？その理由は何か？</li>
</ol></section></section><section id="references" class="level2" data-number="11.11"><h2 data-number="11.11" class="anchored" data-anchor-id="references">
<span class="header-section-number">11.11</span> References</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Alexander:2008th" class="csl-entry" role="listitem">
Alexander, Gordon J, and Mark A Peterson. 2008. <span>“The Effect of Price Tests on Trader Behavior and Market Quality: An Analysis of Reg SHO.”</span> <em>Journal of Financial Markets</em> 11 (1): 84–111.
</div>
<div id="ref-Armstrong:2021uo" class="csl-entry" role="listitem">
Armstrong, Christopher, John D Kepler, Delphine Samuels, and Daniel Taylor. 2022. <span>“Causality Redux: The Evolution of Empirical Methods in Accounting Research and the Growth of Quasi-Experiments.”</span> <em>Journal of Accounting and Economics</em> 74 (2-3): 101521.
</div>
<div id="ref-Card:1994aa" class="csl-entry" role="listitem">
Card, David, and Alan B Krueger. 2000. <span>“Minimum Wages and Employment: A Case Study of the Fast-Food Industry in New Jersey and Pennsylvania: Reply.”</span> <em>American Economic Review</em> 90 (5): 1397–1420.
</div>
<div id="ref-Chen:2018wh" class="csl-entry" role="listitem">
Chen, Wei, Paul Hribar, and Samuel Melessa. 2018. <span>“Incorrect Inferences When Using Residuals as Dependent Variables.”</span> <em>Journal of Accounting Research</em> 56 (3): 751–96.
</div>
<div id="ref-Diether:2009vu" class="csl-entry" role="listitem">
Diether, Karl B, Kuan-Hui Lee, and Ingrid M Werner. 2009. <span>“Short-Sale Strategies and Return Predictability.”</span> <em>The Review of Financial Studies</em> 22 (2): 575–607.
</div>
<div id="ref-Frison:1992te" class="csl-entry" role="listitem">
Frison, Lars, and Stuart J Pocock. 1992. <span>“Repeated Measures in Clinical Trials: Analysis Using Mean Summary Statistics and Its Implications for Design.”</span> <em>Statistics in Medicine</em> 11 (13): 1685–1704.
</div>
<div id="ref-Kelly:2012ul" class="csl-entry" role="listitem">
Kelly, Bryan, and Alexander Ljungqvist. 2012. <span>“Testing Asymmetric-Information Asset Pricing Models.”</span> <em>The Review of Financial Studies</em> 25 (5): 1366–1413.
</div>
<div id="ref-Kothari:2005aa" class="csl-entry" role="listitem">
Kothari, Sagar P, Andrew J Leone, and Charles E Wasley. 2005. <span>“Performance Matched Discretionary Accrual Measures.”</span> <em>Journal of Accounting and Economics</em> 39 (1): 163–97.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>We exclude non-positive values of <code>exchcd</code> as these appear to be rows flagging special temporary trading statuses that create duplicate rows.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>In other words, we don’t need date ranges in the <code>gvkeys</code> table.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>999<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/so-ichi\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./chap18_Causal_mechanisms.html" class="pagination-link" aria-label="因果メカニズム">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">因果メカニズム</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./appA_LinearAlgebra.html" class="pagination-link" aria-label="線形代数">
        <span class="nav-page-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">線形代数</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Soichi Matsuura</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ma2ura">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/matsuura_rits">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>